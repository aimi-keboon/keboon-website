<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Farm Profile - Keboon Directory</title>
    
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1b5e3f 0%, #52ae77 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2d5016 0%, #3f6b20 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            height: 40px;
            width: auto;
            filter: brightness(0) invert(1);
        }

        .header-info h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .header-info p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .back-btn, .save-btn {
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            text-decoration: none;
            color: white;
        }

        .save-btn {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #212529;
        }

        .save-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            transform: translateY(-2px);
        }

        .save-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Loading State */
        .loading-section {
            padding: 80px 40px;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #3f6b20;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error State */
        .error-section {
            padding: 80px 40px;
            text-align: center;
            color: #dc3545;
        }

        /* Main Content */
        .main-content {
            display: none;
            padding: 40px;
        }

        /* Form Styles */
        .form-content {
            max-width: 900px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 600;
            color: #2d5016;
            margin-bottom: 10px;
            text-align: center;
        }

        .page-subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom:25px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            color: #2d5016;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .required::after {
            content: " *";
            color: #dc3545;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="url"],
        select,
        textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3f6b20;
            box-shadow: 0 0 0 3px rgba(63, 107, 32, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Location Map */
        .location-section {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .location-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }

        #editLocationMap {
            height: 350px;
            width: 100%;
            border-radius: 12px;
            border: 2px solid #ced4da;
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3f6b20;
            color: white;
        }

        .btn-primary:hover {
            background: #2d5016;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Products Table */
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .products-table th,
        .products-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .products-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2d5016;
            font-size: 1rem;
        }

        .products-table input,
        .products-table select {
            margin: 0;
            border: 1px solid #ced4da;
            padding: 10px 14px;
            font-size: 1rem;
            border-radius: 8px;
        }

        .products-table input[type="number"] {
            width: 100px;
        }

        .products-table select {
            width: 100%;
            min-width: 120px;
        }

        .radio-group {
            display: flex;
            gap: 25px;
            margin-top: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: normal;
            cursor: pointer;
            font-size: 1rem;
        }

        .radio-label input[type="radio"] {
            width: auto;
            margin: 0;
            transform: scale(1.2);
        }

        .submit-section {
            text-align: center;
            padding-top: 40px;
            border-top: 2px solid #e9ecef;
            margin-top: 30px;
        }

        .submit-btn {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: #212529;
            padding: 18px 50px;
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 193, 7, 0.4);
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 193, 7, 0.6);
        }

        .submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Messages */
        .error-message {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            padding: 15px 20px;
            border: 2px solid #f5c6cb;
            border-radius: 12px;
            margin-bottom: 25px;
            display: none;
            font-weight: 600;
        }

        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            padding: 15px 20px;
            border: 2px solid #c3e6cb;
            border-radius: 12px;
            margin-bottom: 25px;
            display: none;
            font-weight: 600;
        }

        /* Phone Input */
        .phone-input-container {
            display: flex;
            gap: 0;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            background: white;
        }

        .phone-input-container:focus-within {
            border-color: #3f6b20;
            box-shadow: 0 0 0 3px rgba(63, 107, 32, 0.1);
        }

        .country-code-select {
            border: none;
            background: #f8f9fa;
            padding: 14px 8px;
            font-size: 0.85rem;
            font-weight: 600;
            color: #2d5016;
            width: 85px;
            flex-shrink: 0;
            border-right: 2px solid #e9ecef;
            outline: none;
            cursor: pointer;
        }

        .phone-input-container input[type="tel"] {
            border: none;
            padding: 14px 18px;
            font-size: 1rem;
            flex: 1;
            outline: none;
            background: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 50px;
            }

            .header {
                padding: 20px;
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header-left {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }

            .main-content {
                padding: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 0;
            }

            .location-input-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            #editLocationMap {
                height: 280px;
            }

            .radio-group {
                flex-direction: column;
                gap: 15px;
            }

            .products-table,
            .products-table thead,
            .products-table tbody,
            .products-table th,
            .products-table td,
            .products-table tr {
                display: block;
            }

            .products-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            .products-table tr {
                border: 2px solid #ddd;
                margin-bottom: 15px;
                padding: 15px;
                border-radius: 12px;
                background: white;
            }

            .products-table td {
                border: none;
                position: relative;
                padding: 10px 0 10px 35%;
                border-bottom: 1px solid #eee;
            }

            .products-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 30%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: #2d5016;
                font-size: 0.9rem;
            }

            .products-table input,
            .products-table select {
                width: 100%;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <img src="assets/img/keboon-logo-white.png" alt="Keboon" class="logo" id="headerLogo">
                <div class="header-info">
                    <h1>Edit Profile</h1>
                </div>
            </div>
            <div class="header-actions">
                <button type="button" class="save-btn" id="quickSaveBtn" onclick="handleFormSubmission()" disabled>
                    
                    Save
                </button>
                <a href="#" class="back-btn" id="backBtn">
                   
                    Dashboard
                </a>
            </div>
        </div>

        <!-- Loading Section -->
        <div class="loading-section" id="loadingSection">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading farm information...</div>
        </div>

        <!-- Error Section -->
        <div class="error-section" id="errorSection" style="display: none;">
            <h3>Unable to Load Farm Information</h3>
            <p id="errorMessage">There was an error loading your farm information.</p>
            <a href="#" class="back-btn" id="errorBackBtn">Return to Dashboard</a>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <div class="form-content">
                

                <div class="error-message" id="editErrorMessage"></div>
                <div class="success-message" id="editSuccessMessage"></div>

                <form id="editFarmerForm">
                    <div class="form-group">
                        <label for="editFarmName" class="required">Farm/Business Name</label>
                        <input type="text" id="editFarmName" name="farmName" required />
                    </div>

                    <div class="form-group">
                        <label for="editContactName" class="required">Contact Person Name</label>
                        <input type="text" id="editContactName" name="contactName" required />
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editCategory" class="required">Farm Category</label>
                            <select id="editCategory" name="category" required>
                                <option value="">Select Category</option>
                                <option value="Home Grower">Home Grower (micro/backyard)</option>
                                <option value="Homesteading">Homesteading (medium-small)</option>
                                <option value="Small Scale">Small Scale (&lt;1.5 ha)</option>
                                <option value="Medium Scale">Medium Scale</option>
                                <option value="Large Scale">Large Scale</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="editCommercial" class="required">Commercial Status</label>
                            <select id="editCommercial" name="commercial" required>
                                <option value="">Select Status</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Non-commercial">Non-commercial</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editLocation" class="required">Farm Location</label>
                        <div class="location-section">
                            <div class="location-input-row">
                                <input
                                    type="number"
                                    id="editLatitude"
                                    name="latitude"
                                    step="any"
                                    required
                                    placeholder="Latitude (e.g., 3.139)"
                                    oninput="autoUpdateMapFromCoordinates()"
                                />
                                <input
                                    type="number"
                                    id="editLongitude"
                                    name="longitude"
                                    step="any"
                                    required
                                    placeholder="Longitude (e.g., 101.6869)"
                                    oninput="autoUpdateMapFromCoordinates()"
                                />
                                <button type="button" class="btn btn-primary" onclick="getCurrentLocation()">
                                    Use My Current Location
                                </button>
                            </div>
                            <div class="location-map-container">
                                <div id="editLocationMap"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="editPhone" class="required">Phone Number</label>
                            <div class="phone-input-container">
                                <select id="editCountryCode" name="countryCode" class="country-code-select" required>
                                    <option value="+60">🇲🇾 +60 (Malaysia)</option>
                                    <option value="+65">🇸🇬 +65 (Singapore)</option>
                                    <option value="+62">🇮🇩 +62 (Indonesia)</option>
                                    <option value="+66">🇹🇭 +66 (Thailand)</option>
                                    <option value="+84">🇻🇳 +84 (Vietnam)</option>
                                    <option value="+63">🇵🇭 +63 (Philippines)</option>
                                    <option value="+673">🇧🇳 +673 (Brunei)</option>
                                    <option value="+856">🇱🇦 +856 (Laos)</option>
                                    <option value="+855">🇰🇭 +855 (Cambodia)</option>
                                    <option value="+95">🇲🇲 +95 (Myanmar)</option>
                                    <option value="+1">🇺🇸 +1 (USA/Canada)</option>
                                    <option value="+44">🇬🇧 +44 (UK)</option>
                                    <option value="+61">🇦🇺 +61 (Australia)</option>
                                    <option value="+86">🇨🇳 +86 (China)</option>
                                    <option value="+81">🇯🇵 +81 (Japan)</option>
                                    <option value="+82">🇰🇷 +82 (South Korea)</option>
                                    <option value="+91">🇮🇳 +91 (India)</option>
                                </select>
                                <input
                                    type="tel"
                                    id="editPhone"
                                    name="phone"
                                    placeholder="123456789"
                                    pattern="[0-9]+"
                                    title="Please enter numbers only (without country code or + sign)"
                                    required
                                />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="editEmail" class="required">Email Address</label>
                            <input type="email" id="editEmail" name="email" required />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="editAddress" class="required">Address/Location Description</label>
                        <textarea
                            id="editAddress"
                            name="address"
                            placeholder="e.g., 123 Farm Road, Village Name, District"
                            required
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editProducts" class="required">Product List</label>
                        <table class="products-table" id="editProductsTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Availability</th>
                                    <th>Price (RM)</th>
                                    <th>Unit</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="editProductsTableBody">
                                <tr>
                                    <td data-label="Name">
                                        <input type="text" name="productName[]" placeholder="e.g., Tomatoes" required />
                                    </td>
                                    <td data-label="Availability">
                                        <input type="text" name="productSeason[]" placeholder="e.g., March-Oct" required />
                                    </td>
                                    <td data-label="Price (RM)">
                                        <input type="number" name="productPrice[]" step="0.01" min="0" placeholder="0.00" required />
                                    </td>
                                    <td data-label="Unit">
                                        <select name="productUnit[]" required>
                                            <option value="">Select Unit</option>
                                            <option value="kg">per kg</option>
                                            <option value="g">per g</option>
                                            <option value="l">per liter</option>
                                            <option value="ml">per ml</option>
                                            <option value="piece">per piece</option>
                                            <option value="dozen">per dozen</option>
                                            <option value="bundle">per bundle</option>
                                            <option value="box">per box</option>
                                            <option value="bag">per bag</option>
                                            <option value="tray">per tray</option>
                                            <option value="pack">per pack</option>
                                            <option value="bunch">per bunch</option>
                                        </select>
                                    </td>
                                    <td data-label="Action">
                                        <button type="button" class="btn btn-danger" onclick="removeProductRow(this)" disabled>
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-success add-product-btn" onclick="addProductRow()">
                            + Add Another Product
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="editFarmSize" class="required">Farm Size</label>
                        <input type="text" id="editFarmSize" name="farmSize" placeholder="e.g., 0.5 hectares" required />
                    </div>

                    <div class="form-group">
                        <label for="editWebsites" class="required">Website/Social Media Links</label>
                        <table class="products-table" id="editWebsitesTable">
                            <thead>
                                <tr>
                                    <th>URL/Link</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="editWebsitesTableBody">
                                <tr>
                                    <td data-label="URL">
                                        <input type="url" name="websiteUrl[]" placeholder="https://..." required />
                                    </td>
                                    <td data-label="Action">
                                        <button type="button" class="btn btn-danger" onclick="removeWebsiteRow(this)" disabled>
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-success add-product-btn" onclick="addWebsiteRow()">
                            + Add Another Link
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="editDescription" class="required">Brief Description</label>
                        <textarea
                            id="editDescription"
                            name="description"
                            placeholder="Tell us about your farm, farming methods, what makes you unique..."
                            required
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label class="required">Available for visits/tours?</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="visitsAllowed" value="Yes" required />
                                Yes, visitors welcome
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="visitsAllowed" value="No" required />
                                No, not open for visits
                            </label>
                        </div>
                    </div>

                    <div class="submit-section">
                        <button type="submit" class="submit-btn" id="editSubmitBtn">
                            Update My Farm Information
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <script>
        // Global variables
        let farmerData = null;
        let editLocationMap = null;
        let editLocationMarker = null;

        // Google Apps Script URL
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwW3WQVXCKLco3YWjXvCMK90v1nvV99U2vZmEJP2UTMtvmtNp-15a7JCyn3IbEk8HKu/exec";

        // Get URL parameters
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                keboonId: urlParams.get('keboonId'),
                phone: urlParams.get('phone')
            };
        }

        // Load farmer data
        async function loadFarmerData() {
            const params = getUrlParams();
            
            if (!params.keboonId || !params.phone) {
                showError("Invalid access. Please login again.");
                return;
            }

            // Update back button link
            document.getElementById('backBtn').href = `farmer-dashboard.html?keboonId=${encodeURIComponent(params.keboonId)}&phone=${encodeURIComponent(params.phone)}`;
            document.getElementById('errorBackBtn').href = `farmer-dashboard.html?keboonId=${encodeURIComponent(params.keboonId)}&phone=${encodeURIComponent(params.phone)}`;

            try {
                const response = await fetch(
                    `${APPS_SCRIPT_URL}?action=getFarmerById&keboonId=${encodeURIComponent(params.keboonId)}&phone=${encodeURIComponent(params.phone)}`
                );
                const result = await response.json();

                if (result.success && result.farmer) {
                    farmerData = result.farmer;
                    populateForm();
                    hideLoading();
                    showMainContent();
                    
                    // Initialize map after content is visible
                    setTimeout(() => {
                        initEditLocationMap();
                    }, 100);
                } else {
                    throw new Error(result.error || "Farmer not found");
                }
            } catch (error) {
                console.error("Error loading farmer data:", error);
                showError(`Error loading farm information: ${error.message}`);
            }
        }

        // Initialize edit location map
        function initEditLocationMap() {
            if (editLocationMap) {
                editLocationMap.remove();
            }

            const defaultCenter = [3.139, 101.6869];
            editLocationMap = L.map('editLocationMap').setView(defaultCenter, 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(editLocationMap);

            // Add click event to set farm location
            editLocationMap.on('click', function(e) {
                setFarmLocation(e.latlng.lat, e.latlng.lng);
            });

            // Set current farm location if available
            if (farmerData && farmerData.latitude && farmerData.longitude) {
                const lat = parseFloat(farmerData.latitude);
                const lng = parseFloat(farmerData.longitude);
                editLocationMap.setView([lat, lng], 16);
                setFarmLocation(lat, lng);
            }
        }

        // Populate form with current farmer data
        function populateForm() {
            if (!farmerData) return;


            // Basic fields
            document.getElementById('editFarmName').value = farmerData.farmName || '';
            document.getElementById('editContactName').value = farmerData.contactName || '';
            document.getElementById('editCategory').value = farmerData.category || '';
            document.getElementById('editCommercial').value = farmerData.commercial || '';
            
            // Parse the stored phone number to separate country code and number
            const fullPhone = String(farmerData.phone || '');
            if (fullPhone) {
                const countryCodeMatch = fullPhone.match(/^(60|65|62|66|84|63|673|856|855|95|1|44|61|86|81|82|91)/);
                if (countryCodeMatch) {
                    const countryCode = '+' + countryCodeMatch[1];
                    const phoneNumber = fullPhone.substring(countryCodeMatch[1].length);
                    document.getElementById('editCountryCode').value = countryCode;
                    document.getElementById('editPhone').value = phoneNumber;
                } else {
                    document.getElementById('editCountryCode').value = '+60';
                    document.getElementById('editPhone').value = fullPhone;
                }
            }

            document.getElementById('editEmail').value = farmerData.email || '';
            document.getElementById('editAddress').value = farmerData.address || '';
            document.getElementById('editFarmSize').value = farmerData.farmSize || '';
            document.getElementById('editDescription').value = farmerData.description || '';

            // Set location
            if (farmerData.latitude && farmerData.longitude) {
                document.getElementById('editLatitude').value = parseFloat(farmerData.latitude);
                document.getElementById('editLongitude').value = parseFloat(farmerData.longitude);
            }

            // Set visits allowed
            const visitsRadio = document.querySelector(`input[name="visitsAllowed"][value="${farmerData.visitsAllowed}"]`);
            if (visitsRadio) {
                visitsRadio.checked = true;
            }

            // Populate products
            populateProductsTable();

            // Populate websites
            populateWebsitesTable();

            // Enable quick save button
            document.getElementById('quickSaveBtn').disabled = false;
        }

        // Populate products table
        function populateProductsTable() {
            let products = [];
            if (farmerData.products) {
                if (typeof farmerData.products === 'string') {
                    try {
                        products = JSON.parse(farmerData.products);
                    } catch (e) {
                        products = [];
                    }
                } else {
                    products = farmerData.products;
                }
            }

            if (products && products.length > 0) {
                const tbody = document.getElementById('editProductsTableBody');
                tbody.innerHTML = '';

                products.forEach((product, index) => {
                    const newRow = tbody.insertRow();
                    newRow.innerHTML = `
                        <td data-label="Name"><input type="text" name="productName[]" value="${product.name || ''}" placeholder="e.g., Tomatoes" required></td>
                        <td data-label="Availability"><input type="text" name="productSeason[]" value="${product.season || ''}" placeholder="e.g., March-Oct" required></td>
                        <td data-label="Price (RM)"><input type="number" name="productPrice[]" value="${product.price || ''}" step="0.01" min="0" placeholder="0.00" required></td>
                        <td data-label="Unit">
                            <select name="productUnit[]" required>
                                <option value="">Select Unit</option>
                                <option value="kg" ${product.unit === 'kg' ? 'selected' : ''}>per kg</option>
                                <option value="g" ${product.unit === 'g' ? 'selected' : ''}>per g</option>
                                <option value="l" ${product.unit === 'l' ? 'selected' : ''}>per liter</option>
                                <option value="ml" ${product.unit === 'ml' ? 'selected' : ''}>per ml</option>
                                <option value="piece" ${product.unit === 'piece' ? 'selected' : ''}>per piece</option>
                                <option value="dozen" ${product.unit === 'dozen' ? 'selected' : ''}>per dozen</option>
                                <option value="bundle" ${product.unit === 'bundle' ? 'selected' : ''}>per bundle</option>
                                <option value="box" ${product.unit === 'box' ? 'selected' : ''}>per box</option>
                                <option value="bag" ${product.unit === 'bag' ? 'selected' : ''}>per bag</option>
                                <option value="tray" ${product.unit === 'tray' ? 'selected' : ''}>per tray</option>
                                <option value="pack" ${product.unit === 'pack' ? 'selected' : ''}>per pack</option>
                                <option value="bunch" ${product.unit === 'bunch' ? 'selected' : ''}>per bunch</option>
                            </select>
                        </td>
                        <td data-label="Action"><button type="button" class="btn btn-danger" onclick="removeProductRow(this)" ${index === 0 ? 'disabled' : ''}>Remove</button></td>
                    `;
                });
                updateRemoveButtons();
            }
        }

        // Populate websites table
        function populateWebsitesTable() {
            let websites = [];
            if (farmerData.websites) {
                if (typeof farmerData.websites === 'string') {
                    try {
                        websites = JSON.parse(farmerData.websites);
                    } catch (e) {
                        websites = [];
                    }
                } else {
                    websites = farmerData.websites;
                }
            }

            if (websites && websites.length > 0) {
                const tbody = document.getElementById('editWebsitesTableBody');
                tbody.innerHTML = '';

                websites.forEach((url, index) => {
                    const newRow = tbody.insertRow();
                    newRow.innerHTML = `
                        <td data-label="URL"><input type="url" name="websiteUrl[]" value="${url || ''}" placeholder="https://..." required></td>
                        <td data-label="Action"><button type="button" class="btn btn-danger" onclick="removeWebsiteRow(this)" ${index === 0 ? 'disabled' : ''}>Remove</button></td>
                    `;
                });
                updateWebsiteRemoveButtons();
            }
        }

        // Set farm location on map and update form
        function setFarmLocation(lat, lng) {
            // Update form fields
            document.getElementById('editLatitude').value = lat.toFixed(6);
            document.getElementById('editLongitude').value = lng.toFixed(6);

            // Remove existing marker if any
            if (editLocationMarker) {
                editLocationMap.removeLayer(editLocationMarker);
            }

            // Add new marker
            editLocationMarker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: "data:image/svg+xml;charset=UTF-8," + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#3f6b20" width="30" height="30">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                    `),
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                }),
                draggable: true
            }).addTo(editLocationMap);

            editLocationMarker.bindPopup(`<b>📍 Your Farm Location</b><br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}`);

            // Make marker draggable
            editLocationMarker.on('dragend', function(e) {
                const newPos = e.target.getLatLng();
                setFarmLocation(newPos.lat, newPos.lng);
            });
        }

        // Auto-update map when coordinates are entered (with debouncing)
        let coordinateUpdateTimeout = null;

        function autoUpdateMapFromCoordinates() {
            // Clear existing timeout
            if (coordinateUpdateTimeout) {
                clearTimeout(coordinateUpdateTimeout);
            }

            // Set new timeout to avoid too many updates while typing
            coordinateUpdateTimeout = setTimeout(() => {
                const latInput = document.getElementById('editLatitude');
                const lngInput = document.getElementById('editLongitude');

                const lat = parseFloat(latInput.value);
                const lng = parseFloat(lngInput.value);

                // Only update if both values are valid numbers and within range
                if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180 && latInput.value && lngInput.value) {
                    if (editLocationMap) {
                        // Update map view
                        editLocationMap.setView([lat, lng], 16);
                        // Update marker
                        setFarmLocation(lat, lng);
                    }
                }
            }, 500); // Wait 500ms after user stops typing
        }

        // Get current location
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        // Set location on map
                        if (editLocationMap) {
                            editLocationMap.setView([lat, lng], 16);
                            setFarmLocation(lat, lng);
                        }
                    },
                    function(error) {
                        showError('Unable to get your location. Please click on the map to set your farm location manually.');
                    }
                );
            } else {
                showError('Geolocation is not supported by this browser. Please click on the map to set your location.');
            }
        }

        // Products table management
        function addProductRow() {
            const tbody = document.getElementById('editProductsTableBody');
            const rowCount = tbody.rows.length;

            if (rowCount >= 10) {
                showError('Maximum 10 products allowed.');
                return;
            }

            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td data-label="Name"><input type="text" name="productName[]" placeholder="e.g., Tomatoes" required></td>
                <td data-label="Availability"><input type="text" name="productSeason[]" placeholder="e.g., March-Oct" required></td>
                <td data-label="Price (RM)"><input type="number" name="productPrice[]" step="0.01" min="0" placeholder="0.00" required></td>
                <td data-label="Unit">
                    <select name="productUnit[]" required>
                        <option value="">Select Unit</option>
                        <option value="kg">per kg</option>
                        <option value="g">per g</option>
                        <option value="l">per liter</option>
                        <option value="ml">per ml</option>
                        <option value="piece">per piece</option>
                        <option value="dozen">per dozen</option>
                        <option value="bundle">per bundle</option>
                        <option value="box">per box</option>
                        <option value="bag">per bag</option>
                        <option value="tray">per tray</option>
                        <option value="pack">per pack</option>
                        <option value="bunch">per bunch</option>
                    </select>
                </td>
                <td data-label="Action"><button type="button" class="btn btn-danger" onclick="removeProductRow(this)">Remove</button></td>
            `;

            updateRemoveButtons();
        }

        function removeProductRow(button) {
            const tbody = document.getElementById('editProductsTableBody');
            if (tbody.rows.length > 1) {
                button.closest('tr').remove();
                updateRemoveButtons();
            }
        }

        function updateRemoveButtons() {
            const tbody = document.getElementById('editProductsTableBody');
            const removeButtons = tbody.querySelectorAll('.btn-danger');

            removeButtons.forEach((button, index) => {
                button.disabled = tbody.rows.length === 1;
            });
        }

        // Website/Social Media table management
        function addWebsiteRow() {
            const tbody = document.getElementById('editWebsitesTableBody');
            const rowCount = tbody.rows.length;

            if (rowCount >= 10) {
                showError('Maximum 10 links allowed.');
                return;
            }

            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td data-label="URL"><input type="url" name="websiteUrl[]" placeholder="https://..." required></td>
                <td data-label="Action"><button type="button" class="btn btn-danger" onclick="removeWebsiteRow(this)">Remove</button></td>
            `;

            updateWebsiteRemoveButtons();
        }

        function removeWebsiteRow(button) {
            const tbody = document.getElementById('editWebsitesTableBody');
            if (tbody.rows.length > 1) {
                button.closest('tr').remove();
                updateWebsiteRemoveButtons();
            }
        }

        function updateWebsiteRemoveButtons() {
            const tbody = document.getElementById('editWebsitesTableBody');
            const removeButtons = tbody.querySelectorAll('.btn-danger');

            removeButtons.forEach((button, index) => {
                button.disabled = tbody.rows.length === 1;
            });
        }

        // Collect products data as JSON
        function collectProductsData() {
            const products = [];
            const nameInputs = document.querySelectorAll('input[name="productName[]"]');
            const seasonInputs = document.querySelectorAll('input[name="productSeason[]"]');
            const priceInputs = document.querySelectorAll('input[name="productPrice[]"]');
            const unitSelects = document.querySelectorAll('select[name="productUnit[]"]');

            for (let i = 0; i < nameInputs.length; i++) {
                const name = nameInputs[i].value.trim();
                const season = seasonInputs[i].value.trim();
                const price = parseFloat(priceInputs[i].value) || 0;
                const unit = unitSelects[i].value;

                if (name) {
                    products.push({
                        name: name,
                        season: season || 'Not specified',
                        price: price,
                        unit: unit || 'piece'
                    });
                }
            }

            return JSON.stringify(products);
        }

        // Collect websites data as JSON
        function collectWebsitesData() {
            const websites = [];
            const urlInputs = document.querySelectorAll('input[name="websiteUrl[]"]');

            for (let i = 0; i < urlInputs.length; i++) {
                const url = urlInputs[i].value.trim();
                if (url) {
                    websites.push(url);
                }
            }

            return JSON.stringify(websites);
        }

        // Combine country code with phone number
        function getFullPhoneNumber() {
            const countryCode = document.getElementById('editCountryCode').value;
            const phoneNumber = document.getElementById('editPhone').value;

            // Remove any non-digit characters from phone number
            const cleanNumber = phoneNumber.replace(/\D/g, '');

            // Remove the + from country code and combine
            const cleanCountryCode = countryCode.replace('+', '');

            return cleanCountryCode + cleanNumber;
        }

        // Form validation
        function validateForm() {
            hideMessages();

            // Check if location is set
            const lat = document.getElementById('editLatitude').value;
            const lng = document.getElementById('editLongitude').value;

            if (!lat || !lng) {
                showError('Please set your farm location by clicking on the map or using the "Use My Current Location" button.');
                return false;
            }

            // Check if at least one product is filled
            const nameInputs = document.querySelectorAll('input[name="productName[]"]');
            let hasProduct = false;

            for (let input of nameInputs) {
                if (input.value.trim()) {
                    hasProduct = true;
                    break;
                }
            }

            if (!hasProduct) {
                showError('Please add at least one product/crop.');
                return false;
            }

            // Check if at least one website is filled
            const urlInputs = document.querySelectorAll('input[name="websiteUrl[]"]');
            let hasWebsite = false;

            for (let input of urlInputs) {
                if (input.value.trim()) {
                    hasWebsite = true;
                    break;
                }
            }

            if (!hasWebsite) {
                showError('Please add at least one website or social media link.');
                return false;
            }

            return true;
        }

        // Form submission handler
        async function handleFormSubmission() {
            const form = document.getElementById('editFarmerForm');

            // Validate form first
            if (!validateForm()) {
                return;
            }

            // Get URL parameters
            const params = getUrlParams();
            if (!params.keboonId || !params.phone) {
                showError('Invalid session. Please login again.');
                return;
            }

            // Disable submit buttons to prevent double submission
            const submitBtn = document.getElementById('editSubmitBtn');
            const quickSaveBtn = document.getElementById('quickSaveBtn');
            const originalSubmitText = submitBtn.textContent;
            const originalQuickText = quickSaveBtn.textContent;
            
            submitBtn.disabled = true;
            quickSaveBtn.disabled = true;
            submitBtn.textContent = '🔄 Updating...';
            quickSaveBtn.innerHTML = '<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/></svg> Saving...';

            try {
                // Collect form data
                const formData = new FormData(form);
                const productsJson = collectProductsData();
                const websitesJson = collectWebsitesData();

                // Create submission object
                const submission = {
                    keboonId: params.keboonId,
                    farmName: formData.get('farmName'),
                    contactName: formData.get('contactName'),
                    category: formData.get('category'),
                    commercial: formData.get('commercial'),
                    latitude: parseFloat(formData.get('latitude')),
                    longitude: parseFloat(formData.get('longitude')),
                    phone: getFullPhoneNumber(),
                    email: formData.get('email'),
                    address: formData.get('address'),
                    products: productsJson,
                    farmSize: formData.get('farmSize'),
                    websites: websitesJson,
                    description: formData.get('description'),
                    visitsAllowed: formData.get('visitsAllowed'),
                    timestamp: new Date().toISOString()
                };

                console.log('Submitting update data:', submission);

                const response = await fetch(`${APPS_SCRIPT_URL}?action=updateFarmer&data=${encodeURIComponent(JSON.stringify(submission))}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    let successMessage = 'Farm information updated successfully!';
                    
                    if (result.emailSent) {
                        successMessage += '<br><br>A confirmation email has been sent to your registered email address.';
                    } else if (result.emailError) {
                        successMessage += '<br><br>Note: Confirmation email could not be sent.';
                    }

                    showSuccess(successMessage);

                    // Redirect back to dashboard after success
                    setTimeout(() => {
                        window.location.href = `farmer-dashboard.html?keboonId=${encodeURIComponent(params.keboonId)}&phone=${encodeURIComponent(params.phone)}`;
                    }, 2000);

                } else {
                    throw new Error(result.error || 'Failed to update farm information');
                }

            } catch (error) {
                console.error('Error updating farm information:', error);
                showError(`Error: ${error.message}`);
            } finally {
                // Re-enable submit buttons
                submitBtn.disabled = false;
                quickSaveBtn.disabled = false;
                submitBtn.textContent = originalSubmitText;
                quickSaveBtn.innerHTML = originalQuickText;
            }
        }

        // Show/hide messages
        function showError(message) {
            hideMessages();
            const errorDiv = document.getElementById('editErrorMessage');
            errorDiv.innerHTML = message;
            errorDiv.style.display = 'block';
            
            // Scroll to error message
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function showSuccess(message) {
            hideMessages();
            const successDiv = document.getElementById('editSuccessMessage');
            successDiv.innerHTML = message;
            successDiv.style.display = 'block';
            
            // Scroll to success message
            successDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideMessages() {
            document.getElementById('editErrorMessage').style.display = 'none';
            document.getElementById('editSuccessMessage').style.display = 'none';
        }

        // Show/hide sections
        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorSection').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loadingSection').style.display = 'none';
        }

        function showMainContent() {
            document.getElementById('mainContent').style.display = 'block';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Handle logo error
            const logo = document.getElementById('headerLogo');
            logo.addEventListener('error', function() {
                this.style.display = 'none';
            });

            // Load farmer data
            loadFarmerData();

            // Add form submission handler
            document.getElementById('editFarmerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleFormSubmission();
            });
        });
    </script>
</body>
</html>