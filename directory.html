<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keboon Directory</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1B5E3F 0%, #52AE77 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2d5016 0%, #3f6b20 100%);
            color: white;
            padding: 40px 40px 30px 40px;
            text-align: center;
            position: relative;
        }
        
        .logo-container {
            margin-bottom: 20px;
        }
        
        .logo {
            max-height: 80px;
            width: auto;
            filter: brightness(0) invert(1); /* Makes logo white if it's dark */
        }
        
        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 300;
            letter-spacing: 1px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.4;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 80vh;
        }
        
        .form-section {
            padding: 30px;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            max-height: 85vh;
        }
        
        .map-section {
            position: relative;
        }
        
        #map {
            height: 85vh;
            width: 100%;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #2d5016;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        
        .required::after {
            content: " *";
            color: #dc3545;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="url"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3f6b20;
            box-shadow: 0 0 0 3px rgba(63, 107, 32, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .location-section {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            background: #f8f9fa;
        }
        
        .location-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 15px;
            align-items: end;
        }
        
        .location-map-container {
            position: relative;
        }
        
        #locationMap {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            border: 1px solid #ced4da;
        }
        
        .map-instructions {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
            text-align: center;
        }
        
        .map-instructions p {
            margin: 0;
            color: #1976d2;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #3f6b20;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2d5016;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .products-table th,
        .products-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
        }
        
        .products-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2d5016;
            font-size: 0.9rem;
        }
        
        .products-table input,
        .products-table select {
            margin: 0;
            border: 1px solid #ced4da;
            padding: 6px 10px;
            font-size: 0.9rem;
        }
        
        .products-table input[type="number"] {
            width: 80px;
        }
        
        .products-table select {
            width: 100%;
            min-width: 90px;
        }
        
        .add-product-btn {
            margin-top: 15px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        
        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }
        
        .radio-label input[type="radio"] {
            width: auto;
            margin: 0;
        }
        
        .submit-section {
            text-align: center;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
        }
        
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .leaflet-popup-content {
            font-family: inherit;
            line-height: 1.4;
        }
        
        .popup-farm-name {
            font-weight: 600;
            color: #2d5016;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .popup-category {
            background: #3f6b20;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 5px;
        }
        
        .popup-commercial {
            background: #17a2b8;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 8px;
            margin-left: 5px;
        }
        
        .footer {
            background: linear-gradient(135deg, #2d5016 0%, #3f6b20 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .footer-content {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .footer p {
            margin-bottom: 20px;
            font-size: 1rem;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .website-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 30px;
            font-size: 1rem;
            font-weight: 600;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .website-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .logo {
                max-height: 60px;
            }
            
            .header h1 {
                font-size: 2rem;
                margin-bottom: 8px;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                min-height: auto;
            }
            
            .form-section {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                max-height: none;
                padding: 20px 15px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 0;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            #map {
                height: 60vh;
                min-height: 400px;
            }
            
            #locationMap {
                height: 250px;
            }
            
            .location-input-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .location-input-row input,
            .location-input-row button {
                margin-bottom: 10px;
            }
            
            .products-table,
            .products-table thead,
            .products-table tbody,
            .products-table th,
            .products-table td,
            .products-table tr {
                display: block;
            }
            
            .products-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .products-table tr {
                border: 1px solid #ccc;
                margin-bottom: 10px;
                padding: 10px;
                border-radius: 8px;
                background: white;
            }
            
            .products-table td {
                border: none;
                position: relative;
                padding: 8px 0 8px 30%;
                border-bottom: 1px solid #eee;
            }
            
            .products-table td:before {
                content: attr(data-label);
                position: absolute;
                left: 6px;
                width: 25%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: 600;
                color: #2d5016;
                font-size: 0.8rem;
            }
            
            .products-table input,
            .products-table select {
                width: 100%;
                font-size: 0.9rem;
            }
            
            .radio-group {
                flex-direction: column;
                gap: 10px;
            }
            
            .submit-btn {
                padding: 12px 25px;
                font-size: 1rem;
            }
            
            .footer {
                padding: 20px 15px;
            }
            
            .footer p {
                font-size: 0.9rem;
                margin-bottom: 15px;
            }
            
            .website-btn {
                padding: 10px 25px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .location-section {
                padding: 15px;
            }
            
            #locationMap {
                height: 200px;
            }
            
            .btn {
                padding: 8px 15px;
                font-size: 0.8rem;
            }
            
            .submit-btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <!-- Replace the src with your Keboon logo PNG -->
                <img src="assets/img/keboon-logo-white.png" alt="Keboon Logo" class="logo" id="keboonLogo">
            </div>
            <h1>Directory</h1>
            <p>Connect with local farmers in your area - Add your farm or discover fresh produce nearby</p>
        </div>
        
        <div class="main-content">
            <!-- Form Section -->
            <div class="form-section">
                <form id="farmerForm">
                    <div class="form-group">
                        <label for="farmName" class="required">Farm/Business Name</label>
                        <input type="text" id="farmName" name="farmName" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactName" class="required">Contact Person Name</label>
                        <input type="text" id="contactName" name="contactName" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="category" class="required">Farm Category</label>
                            <select id="category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="Home Grower">Home Grower (micro/backyard)</option>
                                <option value="Homesteading">Homesteading (medium-small)</option>
                                <option value="Small Scale">Small Scale (&lt;1.5 ha)</option>
                                <option value="Medium Scale">Medium Scale</option>
                                <option value="Large Scale">Large Scale</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="commercial" class="required">Commercial Status</label>
                            <select id="commercial" name="commercial" required>
                                <option value="">Select Status</option>
                                <option value="Commercial">Commercial</option>
                                <option value="Non-commercial">Non-commercial</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="location" class="required">Farm Location</label>
                        <div class="location-section">
                            <div class="location-input-row">
                                <input type="number" id="latitude" name="latitude" step="any" required readonly placeholder="Latitude will be set when you pin location">
                                <input type="number" id="longitude" name="longitude" step="any" required readonly placeholder="Longitude will be set when you pin location">
                                <button type="button" class="btn btn-secondary" onclick="getCurrentLocation()">
                                    📍 Use My Current Location
                                </button>
                            </div>
                            <div class="location-map-container">
                                <div id="locationMap"></div>
                                <div class="map-instructions">
                                    <p>📍 Click on the map to pin your farm location, or use the "Use My Current Location" button above</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="phone" class="required">Phone Number</label>
                            <input type="tel" id="phone" name="phone" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="email" class="required">Email Address</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="address" class="required">Address/Location Description</label>
                        <textarea id="address" name="address" placeholder="e.g., 123 Farm Road, Village Name, District" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="products" class="required">Primary Products/Crops</label>
                        <table class="products-table" id="productsTable">
                            <thead>
                                <tr>
                                    <th>Product/Crop Name</th>
                                    <th>Season/Availability</th>
                                    <th>Price (RM)</th>
                                    <th>Unit</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr>
                                    <td data-label="Product Name"><input type="text" name="productName[]" placeholder="e.g., Tomatoes, Rice, Chickens" required></td>
                                    <td data-label="Season"><input type="text" name="productSeason[]" placeholder="e.g., Year-round, March-Oct" required></td>
                                    <td data-label="Price (RM)"><input type="number" name="productPrice[]" step="0.01" min="0" placeholder="0.00" required></td>
                                    <td data-label="Unit">
                                        <select name="productUnit[]" required>
                                            <option value="">Select Unit</option>
                                            <option value="kg">per kg</option>
                                            <option value="g">per g</option>
                                            <option value="l">per liter</option>
                                            <option value="ml">per ml</option>
                                            <option value="piece">per piece</option>
                                            <option value="dozen">per dozen</option>
                                            <option value="bundle">per bundle</option>
                                            <option value="box">per box</option>
                                            <option value="bag">per bag</option>
                                            <option value="tray">per tray</option>
                                            <option value="pack">per pack</option>
                                            <option value="bunch">per bunch</option>
                                        </select>
                                    </td>
                                    <td data-label="Action"><button type="button" class="btn btn-danger" onclick="removeProductRow(this)" disabled>Remove</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-success add-product-btn" onclick="addProductRow()">+ Add Another Product</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="farmSize" class="required">Farm Size</label>
                        <input type="text" id="farmSize" name="farmSize" placeholder="e.g., 0.5 hectares, 2 acres" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="websites" class="required">Website/Social Media Links</label>
                        <table class="products-table" id="websitesTable">
                            <thead>
                                <tr>
                                    <th>URL/Link</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="websitesTableBody">
                                <tr>
                                    <td data-label="Website URL"><input type="url" name="websiteUrl[]" placeholder="https://..." required></td>
                                    <td data-label="Action"><button type="button" class="btn btn-danger" onclick="removeWebsiteRow(this)" disabled>Remove</button></td>
                                </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-success add-product-btn" onclick="addWebsiteRow()">+ Add Another Link</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="description" class="required">Brief Description</label>
                        <textarea id="description" name="description" placeholder="Tell us about your farm, farming methods, what makes you unique..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="required">Available for visits/tours?</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="visitsAllowed" value="Yes" required> 
                                Yes, visitors welcome
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="visitsAllowed" value="No" required> 
                                No, not open for visits
                            </label>
                        </div>
                    </div>
                    
                    <div class="submit-section">
                        <button type="submit" class="submit-btn">🚀 Add My Farm to Keboon Directory</button>
                    </div>
                </form>
            </div>
            
            <!-- Map Section -->
            <div class="map-section">
                <div id="map"></div>
                <div class="map-loading" id="mapLoading">
                    <p>Loading farmers data...</p>
                </div>
            </div>
        </div>
        
        <!-- Footer Section -->
        <div class="footer">
            <div class="footer-content">
                <p>Keboon Directory is part of the Keboon ecosystem - empowering sustainable agriculture and connecting communities with local farmers.</p>
                <a href="https://keboon.net" target="_blank" class="website-btn">
                    🌐 Visit Keboon.net for More Info
                </a>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
        // Global variables
        let map;
        let locationMap;
        let farmersData = [];
        let userMarker = null;
        let locationMarker = null;
        
        // Google Apps Script configuration
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyXZ5dGJXXXQi99VbaPp_tehaed24-IqKEuucotNBkPo6ny1eBRm_-Znsb6XwMXj0RP/exec'; // You'll need to replace this
        
        // Initialize maps
        function initMap() {
            // Initialize main map
            initMainMap();
            // Initialize location picker map
            initLocationMap();
        }
        
        // Initialize main display map
        function initMainMap() {
            // Default center (Kuala Lumpur)
            const defaultCenter = [3.1390, 101.6869];
            
            map = L.map('map').setView(defaultCenter, 10);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18,
            }).addTo(map);
            
            // Try to get user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const userLocation = [position.coords.latitude, position.coords.longitude];
                        map.setView(userLocation, 12);
                        
                        // Add user location marker
                        userMarker = L.marker(userLocation, {
                            icon: L.icon({
                                iconUrl: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ff4444" width="24" height="24">
                                        <circle cx="12" cy="12" r="10" stroke="#fff" stroke-width="2"/>
                                        <circle cx="12" cy="12" r="3" fill="#fff"/>
                                    </svg>
                                `),
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            })
                        }).addTo(map);
                        
                        userMarker.bindPopup('<b>Your Location</b>').openPopup();
                    },
                    function(error) {
                        console.log('Geolocation error:', error);
                        // Stay with default location
                    }
                );
            }
            
            // Load farmers data
            loadFarmersData();
        }
        
        // Initialize location picker map
        function initLocationMap() {
            const defaultCenter = [3.1390, 101.6869];
            
            locationMap = L.map('locationMap').setView(defaultCenter, 12);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18,
            }).addTo(locationMap);
            
            // Try to center on user's location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const userLocation = [position.coords.latitude, position.coords.longitude];
                        locationMap.setView(userLocation, 15);
                    },
                    function(error) {
                        console.log('Geolocation error for location map:', error);
                    }
                );
            }
            
            // Add click event to set farm location
            locationMap.on('click', function(e) {
                setFarmLocation(e.latlng.lat, e.latlng.lng);
            });
        }
        
        // Load farmers data from Google Apps Script
        async function loadFarmersData() {
            document.getElementById('mapLoading').style.display = 'block';
            
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getFarmers`);
                const data = await response.json();
                
                if (data.success) {
                    farmersData = data.farmers;
                    displayFarmersOnMap();
                } else {
                    throw new Error(data.error || 'Failed to load farmers data');
                }
                
            } catch (error) {
                console.error('Error loading farmers data:', error);
                
                // Use sample data as fallback
                const sampleData = [
                    {
                        farmName: "Green Valley Farm",
                        contactName: "Ahmad Rahman",
                        category: "Small Scale",
                        commercial: "Commercial",
                        latitude: 3.1500,
                        longitude: 101.7000,
                        phone: "+60123456789",
                        email: "ahmad@greenvalley.com",
                        address: "Lot 123, Kampung Baru, Selangor",
                        farmSize: "2 hectares",
                        description: "Organic farming with sustainable practices",
                        visitsAllowed: "Yes",
                        products: [
                            {name: "Organic Vegetables", season: "Year-round", price: 8.50, unit: "kg"},
                            {name: "Herbs", season: "Year-round", price: 12.00, unit: "bundle"}
                        ],
                        websites: [
                            "https://facebook.com/greenvalley",
                            "https://wa.me/60123456789"
                        ]
                    },
                    {
                        farmName: "Sunrise Homestead",
                        contactName: "Sarah Lee",
                        category: "Homesteading",
                        commercial: "Non-commercial",
                        latitude: 3.1200,
                        longitude: 101.6500,
                        phone: "+60198765432",
                        email: "sarah@sunrise.com",
                        address: "Jalan Kebun, Petaling Jaya",
                        farmSize: "0.5 hectares",
                        description: "Family homestead focusing on free-range poultry",
                        visitsAllowed: "No",
                        products: [
                            {name: "Free-range Chickens", season: "Year-round", price: 25.00, unit: "kg"},
                            {name: "Eggs", season: "Year-round", price: 8.00, unit: "dozen"}
                        ],
                        websites: [
                            "https://instagram.com/sunrisehomestead",
                            "https://sunrise.com"
                        ]
                    }
                ];
                
                farmersData = sampleData;
                displayFarmersOnMap();
                console.log('Using sample data - please set up Google Apps Script for live data');
            } finally {
                document.getElementById('mapLoading').style.display = 'none';
            }
        }
        
        // Display farmers on map
        function displayFarmersOnMap() {
            farmersData.forEach(farmer => {
                if (farmer.latitude && farmer.longitude) {
                    const marker = L.marker([farmer.latitude, farmer.longitude], {
                        icon: L.icon({
                            iconUrl: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#3f6b20" width="30" height="30">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                </svg>
                            `),
                            iconSize: [30, 30],
                            iconAnchor: [15, 30],
                            popupAnchor: [0, -30]
                        })
                    }).addTo(map);
                    
                    // Create popup content
                    let productsHtml = '';
                    if (farmer.products) {
                        // Handle both JSON string and array formats
                        let products = farmer.products;
                        if (typeof products === 'string') {
                            try {
                                products = JSON.parse(products);
                            } catch (e) {
                                products = [];
                            }
                        }
                        
                        if (products && products.length > 0) {
                            productsHtml = '<br><strong>Products & Prices:</strong><br>';
                            products.forEach(product => {
                                const priceDisplay = product.price && product.price > 0 
                                    ? ` - RM${product.price.toFixed(2)} ${product.unit || 'each'}`
                                    : '';
                                productsHtml += `• ${product.name} (${product.season})${priceDisplay}<br>`;
                            });
                        }
                    }
                    
                    // Create websites content
                    let websitesHtml = '';
                    if (farmer.websites) {
                        let websites = farmer.websites;
                        if (typeof websites === 'string') {
                            try {
                                websites = JSON.parse(websites);
                            } catch (e) {
                                websites = [];
                            }
                        }
                        
                        if (websites && websites.length > 0) {
                            websitesHtml = '<br><strong>Find us online:</strong><br>';
                            websites.forEach(url => {
                                const displayUrl = url.length > 30 ? url.substring(0, 30) + '...' : url;
                                websitesHtml += `🔗 <a href="${url}" target="_blank">${displayUrl}</a><br>`;
                            });
                        }
                    }
                    
                    const popupContent = `
                        <div class="popup-farm-name">${farmer.farmName}</div>
                        <div>
                            <span class="popup-category">${farmer.category}</span>
                            <span class="popup-commercial">${farmer.commercial}</span>
                        </div>
                        <br>
                        <strong>Contact:</strong> ${farmer.contactName}<br>
                        📞 ${farmer.phone}<br>
                        ✉️ ${farmer.email}<br>
                        📍 ${farmer.address}
                        ${productsHtml}
                        ${websitesHtml}
                        <br><strong>Farm Size:</strong> ${farmer.farmSize}<br>
                        <strong>Visits:</strong> ${farmer.visitsAllowed === 'Yes' ? '✅ Visitors welcome' : '❌ Not open for visits'}
                    `;
                    
                    marker.bindPopup(popupContent);
                }
            });
        }
        
        // Set farm location on map and update form
        function setFarmLocation(lat, lng) {
            // Update form fields
            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lng.toFixed(6);
            
            // Remove existing marker if any
            if (locationMarker) {
                locationMap.removeLayer(locationMarker);
            }
            
            // Add new marker
            locationMarker = L.marker([lat, lng], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#3f6b20" width="30" height="30">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                    `),
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                }),
                draggable: true
            }).addTo(locationMap);
            
            locationMarker.bindPopup(`<b>📍 Your Farm Location</b><br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}`);
            
            // Make marker draggable
            locationMarker.on('dragend', function(e) {
                const newPos = e.target.getLatLng();
                setFarmLocation(newPos.lat, newPos.lng);
            });
        }
        
        // Get current location for both form and map
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Set location on form map
                        locationMap.setView([lat, lng], 16);
                        setFarmLocation(lat, lng);
                        
                        alert('📍 Current location set! You can drag the pin to adjust if needed.');
                    },
                    function(error) {
                        alert('Unable to get your location. Please click on the map to set your farm location manually.');
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser. Please click on the map to set your location.');
            }
        }
        
        // Products table management
        function addProductRow() {
            const tbody = document.getElementById('productsTableBody');
            const rowCount = tbody.rows.length;
            
            if (rowCount >= 10) {
                alert('Maximum 10 products allowed.');
                return;
            }
            
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td data-label="Product Name"><input type="text" name="productName[]" placeholder="e.g., Tomatoes, Rice, Chickens" required></td>
                <td data-label="Season"><input type="text" name="productSeason[]" placeholder="e.g., Year-round, March-Oct" required></td>
                <td data-label="Price (RM)"><input type="number" name="productPrice[]" step="0.01" min="0" placeholder="0.00" required></td>
                <td data-label="Unit">
                    <select name="productUnit[]" required>
                        <option value="">Select Unit</option>
                        <option value="kg">per kg</option>
                        <option value="g">per g</option>
                        <option value="l">per liter</option>
                        <option value="ml">per ml</option>
                        <option value="piece">per piece</option>
                        <option value="dozen">per dozen</option>
                        <option value="bundle">per bundle</option>
                        <option value="box">per box</option>
                        <option value="bag">per bag</option>
                        <option value="tray">per tray</option>
                        <option value="pack">per pack</option>
                        <option value="bunch">per bunch</option>
                    </select>
                </td>
                <td data-label="Action"><button type="button" class="btn btn-danger" onclick="removeProductRow(this)">Remove</button></td>
            `;
            
            updateRemoveButtons();
        }
        
        function removeProductRow(button) {
            const tbody = document.getElementById('productsTableBody');
            if (tbody.rows.length > 1) {
                button.closest('tr').remove();
                updateRemoveButtons();
            }
        }
        
        function updateRemoveButtons() {
            const tbody = document.getElementById('productsTableBody');
            const removeButtons = tbody.querySelectorAll('.btn-danger');
            
            removeButtons.forEach((button, index) => {
                button.disabled = tbody.rows.length === 1;
            });
        }
        
        // Website/Social Media table management
        function addWebsiteRow() {
            const tbody = document.getElementById('websitesTableBody');
            const rowCount = tbody.rows.length;
            
            if (rowCount >= 10) {
                alert('Maximum 10 links allowed.');
                return;
            }
            
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td data-label="Website URL"><input type="url" name="websiteUrl[]" placeholder="https://..." required></td>
                <td data-label="Action"><button type="button" class="btn btn-danger" onclick="removeWebsiteRow(this)">Remove</button></td>
            `;
            
            updateWebsiteRemoveButtons();
        }
        
        function removeWebsiteRow(button) {
            const tbody = document.getElementById('websitesTableBody');
            if (tbody.rows.length > 1) {
                button.closest('tr').remove();
                updateWebsiteRemoveButtons();
            }
        }
        
        function updateWebsiteRemoveButtons() {
            const tbody = document.getElementById('websitesTableBody');
            const removeButtons = tbody.querySelectorAll('.btn-danger');
            
            removeButtons.forEach((button, index) => {
                button.disabled = tbody.rows.length === 1;
            });
        }
        
        // Collect products data as JSON
        function collectProductsData() {
            const products = [];
            const nameInputs = document.querySelectorAll('input[name="productName[]"]');
            const seasonInputs = document.querySelectorAll('input[name="productSeason[]"]');
            const priceInputs = document.querySelectorAll('input[name="productPrice[]"]');
            const unitSelects = document.querySelectorAll('select[name="productUnit[]"]');
            
            for (let i = 0; i < nameInputs.length; i++) {
                const name = nameInputs[i].value.trim();
                const season = seasonInputs[i].value.trim();
                const price = parseFloat(priceInputs[i].value) || 0;
                const unit = unitSelects[i].value;
                
                if (name) {
                    products.push({
                        name: name,
                        season: season || 'Not specified',
                        price: price,
                        unit: unit || 'piece'
                    });
                }
            }
            
            return JSON.stringify(products);
        }
        
        // Collect websites data as JSON
        function collectWebsitesData() {
            const websites = [];
            const urlInputs = document.querySelectorAll('input[name="websiteUrl[]"]');
            
            for (let i = 0; i < urlInputs.length; i++) {
                const url = urlInputs[i].value.trim();
                
                if (url) {
                    websites.push(url);
                }
            }
            
            return JSON.stringify(websites);
        }
        
        // Form submission
        document.getElementById('farmerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Disable submit button to prevent double submission
            const submitBtn = this.querySelector('.submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = '🔄 Submitting...';
            
            try {
                // Collect form data
                const formData = new FormData(this);
                const productsJson = collectProductsData();
                const websitesJson = collectWebsitesData();
                
                // Create submission object
                const submission = {
                    farmName: formData.get('farmName'),
                    contactName: formData.get('contactName'),
                    category: formData.get('category'),
                    commercial: formData.get('commercial'),
                    latitude: parseFloat(formData.get('latitude')),
                    longitude: parseFloat(formData.get('longitude')),
                    phone: formData.get('phone'),
                    email: formData.get('email'),
                    address: formData.get('address'),
                    products: productsJson,
                    farmSize: formData.get('farmSize'),
                    websites: websitesJson,
                    description: formData.get('description'),
                    visitsAllowed: formData.get('visitsAllowed'),
                    timestamp: new Date().toISOString()
                };
                
                // Submit to Google Apps Script
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'addFarmer',
                        data: submission
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('🎉 Farm added successfully to Keboon Directory!');
                    this.reset();
                    updateRemoveButtons(); // Reset products table
                    updateWebsiteRemoveButtons(); // Reset websites table
                    // Clear location marker
                    if (locationMarker) {
                        locationMap.removeLayer(locationMarker);
                        locationMarker = null;
                    }
                    loadFarmersData(); // Refresh the map
                } else {
                    throw new Error(result.error || 'Failed to submit form');
                }
                
            } catch (error) {
                console.error('Error submitting form:', error);
                alert('❌ Error submitting form. Please try again or check your internet connection.');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            updateRemoveButtons();
            updateWebsiteRemoveButtons();
            
            // Handle logo error (if logo file doesn't exist)
            const logo = document.getElementById('keboonLogo');
            logo.addEventListener('error', function() {
                // Hide logo container if image fails to load
                document.querySelector('.logo-container').style.display = 'none';
            });
            
            // Fix map sizing issues
            setTimeout(function() {
                if (locationMap) {
                    locationMap.invalidateSize();
                }
            }, 100);
        });
    </script>
</body>
</html>