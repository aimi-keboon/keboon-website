<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Keboon Directory</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1b5e3f 0%, #52ae77 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2d5016 0%, #3f6b20 100%);
        color: white;
        padding: 40px 40px 30px 40px;
        text-align: center;
        position: relative;
      }

      .logo-container {
        margin-bottom: 20px;
      }

      .logo {
        max-height: 80px;
        width: auto;
        filter: brightness(0) invert(1);
      }

      .header h1 {
        font-size: 2.8rem;
        margin-bottom: 10px;
        font-weight: 300;
        letter-spacing: 1px;
      }

      .header p {
        font-size: 1.2rem;
        opacity: 0.95;
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.4;
      }

      /* Farmer Access Buttons */
      .farmer-access {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 25px;
        margin-top: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .farmer-access h3 {
        margin-bottom: 15px;
        font-size: 1.3rem;
        font-weight: 600;
      }

      .farmer-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .farmer-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 12px 24px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1rem;
      }

      .farmer-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
        text-decoration: none;
        color: white;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }

      .farmer-btn svg {
        width: 18px;
        height: 18px;
        fill: currentColor;
      }

      .farmer-btn.primary {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border-color: transparent;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
      }

      .farmer-btn.primary:hover {
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
        background: linear-gradient(135deg, #218838 0%, #1ea085 100%);
      }

      /* Map Section */
      .map-section {
        padding: 30px;
        background: #f8f9fa;
      }

      .map-title {
        text-align: center;
        margin-bottom: 20px;
        color: #2d5016;
      }

      .map-title h2 {
        font-size: 1.8rem;
        margin-bottom: 8px;
      }

      .map-title p {
        color: #6c757d;
        font-size: 1rem;
      }

      #map {
        height: 70vh;
        width: 100%;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        border: 3px solid #3f6b20;
      }

      .map-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        padding: 30px;
        border-radius: 15px;
        display: none;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        text-align: center;
      }

      .loading-spinner {
        width: 32px;
        height: 32px;
        border: 2px solid #f0f0f0;
        border-top: 2px solid #3f6b20;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Statistics */
      .map-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #2d5016;
        margin-bottom: 5px;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Footer */
      .footer {
        background: linear-gradient(135deg, #2d5016 0%, #3f6b20 100%);
        color: white;
        padding: 40px 30px;
        text-align: center;
      }

      .footer-content {
        max-width: 600px;
        margin: 0 auto;
      }

      .footer p {
        margin-bottom: 25px;
        font-size: 1.1rem;
        opacity: 0.95;
        line-height: 1.5;
      }

      .website-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 15px 35px;
        font-size: 1.1rem;
        font-weight: 600;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .website-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        text-decoration: none;
        color: white;
      }

      /* Popup Styles */
      .leaflet-popup-content {
        font-family: inherit;
        line-height: 1.5;
      }

      .popup-farm-name {
        font-weight: 700;
        color: #2d5016;
        font-size: 1.2rem;
        margin-bottom: 10px;
      }

      .popup-category {
        background: #3f6b20;
        color: white;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.85rem;
        display: inline-block;
        margin-bottom: 8px;
        font-weight: 600;
      }

      .popup-commercial {
        background: #17a2b8;
        color: white;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.85rem;
        display: inline-block;
        margin-bottom: 10px;
        margin-left: 8px;
        font-weight: 600;
      }

      .popup-keboon-id {
        background: #6c757d;
        color: white;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        display: inline-block;
        margin-bottom: 10px;
        margin-left: 8px;
        font-weight: 600;
      }

      .popup-products {
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 12px;
        line-height: 1.4;
      }

      .popup-profile-btn {
        background: linear-gradient(135deg, #3f6b20 0%, #2d5016 100%);
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 8px;
        width: 100%;
      }

      .popup-profile-btn:hover {
        background: linear-gradient(135deg, #2d5016 0%, #1a3009 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(63, 107, 32, 0.4);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .header {
          padding: 25px 20px;
        }

        .logo {
          max-height: 60px;
        }

        .header h1 {
          font-size: 2.2rem;
        }

        .header p {
          font-size: 1rem;
        }

        .map-section {
          padding: 20px;
        }

        #map {
          height: 60vh;
          min-height: 400px;
        }

        .farmer-access {
          padding: 20px;
        }

        .farmer-buttons {
          flex-direction: column;
          align-items: center;
        }

        .farmer-btn {
          min-width: 200px;
          justify-content: center;
        }

        .map-stats {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 15px;
        }

        .stat-card {
          padding: 15px;
        }

        .stat-number {
          font-size: 1.5rem;
        }

        .footer {
          padding: 30px 20px;
        }

        .footer p {
          font-size: 1rem;
          margin-bottom: 20px;
        }

        .website-btn {
          padding: 12px 25px;
          font-size: 1rem;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.8rem;
        }

        .farmer-btn {
          padding: 10px 20px;
          font-size: 0.9rem;
        }

        #map {
          height: 50vh;
          min-height: 300px;
        }

        .map-stats {
          grid-template-columns: 1fr 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="logo-container">
          <img
            src="assets/img/keboon-logo-white.png"
            alt="Keboon Logo"
            class="logo"
            id="keboonLogo"
          />
        </div>
        <h1>Directory</h1>
        <p>
          Connect with local farmers in your area - Discover fresh produce and sustainable agriculture
        </p>

        <!-- Farmer Access Section -->
        <div class="farmer-access">
          <div class="farmer-buttons">
            <a href="auth.html?mode=login" class="farmer-btn">
              
              Login
            </a>
            <a href="auth.html?mode=signup" class="farmer-btn primary">
              Register
            </a>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <div class="map-section">
        <div class="map-title">
          <h2>Discover Local Farmers</h2>
          <p>Explore farms and homesteads in your area</p>
        </div>
        <div style="position: relative">
          <div id="map"></div>
          <div class="map-loading" id="mapLoading">
            <div class="loading-spinner"></div>
            <p>Loading farmers data...</p>
          </div>
        </div>

        <!-- Statistics -->
        <div class="map-stats">
          <div class="stat-card">
            <div class="stat-number" id="totalFarms">0</div>
            <div class="stat-label">Local Farms</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalProducts">0</div>
            <div class="stat-label">Products Available</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="totalCategories">0</div>
            <div class="stat-label">Farm Categories</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="commercialFarms">0</div>
            <div class="stat-label">Commercial Farms</div>
          </div>
        </div>
      </div>

      <!-- Footer Section -->
      <div class="footer">
        <div class="footer-content">
          <p>
            Keboon Directory is part of the Keboon ecosystem - empowering
            sustainable agriculture and connecting communities with local
            farmers.
          </p>
          <a href="https://keboon.net" target="_blank" class="website-btn">
            Visit Keboon.net for More Info
          </a>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <script>
      // Global variables
      let map;
      let farmersData = [];
      let userMarker = null;

      // Google Apps Script configuration
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbwW3WQVXCKLco3YWjXvCMK90v1nvV99U2vZmEJP2UTMtvmtNp-15a7JCyn3IbEk8HKu/exec";

      // Generate profile URL from farm name
      function generateProfileUrl(farmName) {
        const baseUrl = farmName
          .toLowerCase()
          .replace(/[^a-z0-9\s]/g, "")
          .replace(/\s+/g, "-")
          .replace(/-+/g, "-")
          .replace(/^-|-$/g, "");

        return `profile.html?farm=${encodeURIComponent(baseUrl)}`;
      }

      // Initialize map
      function initMap() {
        // Default center (Kuala Lumpur)
        const defaultCenter = [3.139, 101.6869];

        map = L.map("map").setView(defaultCenter, 10);

        // Add OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors",
          maxZoom: 18,
        }).addTo(map);

        // Try to get user's location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              const userLocation = [
                position.coords.latitude,
                position.coords.longitude,
              ];
              map.setView(userLocation, 12);

              // Add user location marker
              userMarker = L.marker(userLocation, {
                icon: L.icon({
                  iconUrl:
                    "data:image/svg+xml;charset=UTF-8," +
                    encodeURIComponent(`
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ff4444" width="24" height="24">
                          <circle cx="12" cy="12" r="10" stroke="#fff" stroke-width="2"/>
                          <circle cx="12" cy="12" r="3" fill="#fff"/>
                      </svg>
                    `),
                  iconSize: [24, 24],
                  iconAnchor: [12, 12],
                }),
              }).addTo(map);

              userMarker.bindPopup("<b>Your Location</b>").openPopup();
            },
            function (error) {
              console.log("Geolocation error:", error);
            }
          );
        }

        // Load farmers data
        loadFarmersData();
      }

      // Load farmers data from Google Apps Script
      async function loadFarmersData() {
        document.getElementById("mapLoading").style.display = "block";

        try {
          const response = await fetch(`${APPS_SCRIPT_URL}?action=getFarmers`);

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();

          if (data.success) {
            farmersData = data.farmers;
            displayFarmersOnMap();
            updateStatistics();
          } else {
            throw new Error(data.error || "Failed to load farmers data");
          }
        } catch (error) {
          console.error("Error loading farmers data:", error);

          // Use sample data as fallback
          const sampleData = [
            {
              keboonId: "KB001",
              farmName: "Green Valley Farm",
              contactName: "Ahmad Rahman",
              category: "Small Scale",
              commercial: "Commercial",
              latitude: 3.15,
              longitude: 101.7,
              phone: "+60123456789",
              email: "ahmad@greenvalley.com",
              address: "Lot 123, Kampung Baru, Selangor",
              farmSize: "2 hectares",
              description: "Organic farming with sustainable practices",
              visitsAllowed: "Yes",
              products: [
                {
                  name: "Organic Vegetables",
                  season: "Year-round",
                  price: 8.5,
                  unit: "kg",
                },
                {
                  name: "Herbs",
                  season: "Year-round",
                  price: 12.0,
                  unit: "bundle",
                },
              ],
              websites: [
                "https://facebook.com/greenvalley",
                "https://wa.me/60123456789",
              ],
            },
            {
              keboonId: "KB002",
              farmName: "Sunrise Homestead",
              contactName: "Sarah Lee",
              category: "Homesteading",
              commercial: "Non-commercial",
              latitude: 3.12,
              longitude: 101.65,
              phone: "+60198765432",
              email: "sarah@sunrise.com",
              address: "Jalan Kebun, Petaling Jaya",
              farmSize: "0.5 hectares",
              description: "Family homestead focusing on free-range poultry",
              visitsAllowed: "No",
              products: [
                {
                  name: "Free-range Chickens",
                  season: "Year-round",
                  price: 25.0,
                  unit: "kg",
                },
                {
                  name: "Eggs",
                  season: "Year-round",
                  price: 8.0,
                  unit: "dozen",
                },
              ],
              websites: [
                "https://instagram.com/sunrisehomestead",
                "https://sunrise.com",
              ],
            },
          ];

          farmersData = sampleData;
          displayFarmersOnMap();
          updateStatistics();
        } finally {
          document.getElementById("mapLoading").style.display = "none";
        }
      }

      // Display farmers on map
      function displayFarmersOnMap() {
        farmersData.forEach((farmer) => {
          if (farmer.latitude && farmer.longitude) {
            const marker = L.marker([farmer.latitude, farmer.longitude], {
              icon: L.icon({
                iconUrl:
                  "data:image/svg+xml;charset=UTF-8," +
                  encodeURIComponent(`
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#3f6b20" width="30" height="30">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                    </svg>
                  `),
                iconSize: [30, 30],
                iconAnchor: [15, 30],
                popupAnchor: [0, -30],
              }),
            }).addTo(map);

            // Create popup content
            let productsHtml = "";
            if (farmer.products) {
              let products = farmer.products;
              if (typeof products === "string") {
                try {
                  products = JSON.parse(products);
                } catch (e) {
                  products = [];
                }
              }

              if (products && products.length > 0) {
                productsHtml = "<div class='popup-products'><strong>Products:</strong><br>";
                products.slice(0, 2).forEach((product) => {
                  const priceDisplay =
                    product.price && product.price > 0
                      ? ` - RM${product.price.toFixed(2)}/${product.unit || "each"}`
                      : "";
                  productsHtml += `• ${product.name} (${product.season})${priceDisplay}<br>`;
                });
                if (products.length > 2) {
                  productsHtml += `• And ${products.length - 2} more products...`;
                }
                productsHtml += "</div>";
              }
            }

            const profileUrl = generateProfileUrl(farmer.farmName);

            const popupContent = `
              <div class="popup-farm-name">${farmer.farmName}</div>
              <span class="popup-category">${farmer.category}</span>
              <span class="popup-commercial">${farmer.commercial}</span>
              
              ${productsHtml}
              <button onclick="window.open('${profileUrl}', '_self')" class="popup-profile-btn">
                View Full Profile
              </button>
            `;

            marker.bindPopup(popupContent);
          }
        });
      }

      // Update statistics
      function updateStatistics() {
        const totalFarms = farmersData.length;
        let totalProducts = 0;
        const categories = new Set();
        let commercialCount = 0;

        farmersData.forEach(farmer => {
          // Count categories
          if (farmer.category) {
            categories.add(farmer.category);
          }

          // Count commercial farms
          if (farmer.commercial === "Commercial") {
            commercialCount++;
          }

          // Count products
          if (farmer.products) {
            let products = farmer.products;
            if (typeof products === "string") {
              try {
                products = JSON.parse(products);
              } catch (e) {
                products = [];
              }
            }
            if (products && Array.isArray(products)) {
              totalProducts += products.length;
            }
          }
        });

        document.getElementById('totalFarms').textContent = totalFarms;
        document.getElementById('totalProducts').textContent = totalProducts;
        document.getElementById('totalCategories').textContent = categories.size;
        document.getElementById('commercialFarms').textContent = commercialCount;
      }

      // Initialize everything when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initMap();

        // Handle logo error (if logo file doesn't exist)
        const logo = document.getElementById("keboonLogo");
        logo.addEventListener("error", function () {
          document.querySelector(".logo-container").style.display = "none";
        });
      });
    </script>
  </body>
</html>