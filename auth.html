<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Farmer Authentication - Keboon Directory</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1b5e3f 0%, #52ae77 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2d5016 0%, #3f6b20 100%);
        color: white;
        padding: 30px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .logo {
        height: 40px;
        width: auto;
        filter: brightness(0) invert(1);
      }

      .header-title {
        font-size: 1.8rem;
        font-weight: 600;
      }

      .back-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        text-decoration: none;
        color: white;
      }

      .back-btn svg {
        width: 16px;
        height: 16px;
        fill: currentColor;
      }

      /* Main Content */
      .main-content {
        padding: 40px;
      }

      /* Mode Switcher */
      .mode-switcher {
        display: flex;
        background: #f8f9fa;
        border-radius: 10px;
        padding: 5px;
        margin-bottom: 30px;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
      }

      .mode-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        background: transparent;
        color: #666;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .mode-btn.active {
        background: #3f6b20;
        color: white;
        box-shadow: 0 2px 10px rgba(63, 107, 32, 0.3);
      }

      /* Forms Container */
      .forms-container {
        position: relative;
      }

      .form-section {
        position: static; 
        display: none;
      }

      .form-section.active {
        display: block;
      }

      .form-header {
        text-align: center;
        margin-bottom: 30px;
      }

      .form-title {
        font-size: 2rem;
        color: #2d5016;
        margin-bottom: 10px;
      }

      .form-subtitle {
        color: #666;
        font-size: 1.1rem;
      }

      /* Form Styles */
      .form-content {
        max-width: 600px;
        margin: 0 auto;
        padding-bottom: 40px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      label {
        display: block;
        font-weight: 600;
        color: #2d5016;
        margin-bottom: 8px;
        font-size: 0.95rem;
      }

      .required::after {
        content: " *";
        color: #dc3545;
      }

      input[type="text"],
      input[type="email"],
      input[type="tel"],
      input[type="number"],
      input[type="url"],
      select,
      textarea {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: white;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #3f6b20;
        box-shadow: 0 0 0 3px rgba(63, 107, 32, 0.1);
      }

      textarea {
        resize: vertical;
        min-height: 100px;
      }

      /* Phone Input */
      .phone-input-container {
        display: flex;
        gap: 0;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s ease;
        background: white;
      }

      .phone-input-container:focus-within {
        border-color: #3f6b20;
        box-shadow: 0 0 0 3px rgba(63, 107, 32, 0.1);
      }

      .country-code-select {
        border: none;
        background: #f8f9fa;
        padding: 12px 8px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #2d5016;
        width: 90px;
        flex-shrink: 0;
        border-right: 2px solid #e9ecef;
        outline: none;
        cursor: pointer;
      }

      .country-code-select:focus {
        background: #e9ecef;
      }

      .phone-input-container input[type="tel"] {
        border: none;
        padding: 12px 16px;
        font-size: 1rem;
        flex: 1;
        outline: none;
        background: white;
      }

      .phone-input-container input[type="tel"]:focus {
        border: none;
        box-shadow: none;
      }

      /* Location Map */
      .location-section {
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 20px;
        background: white;
        margin: 20px 0;
      }

      .location-input-row {
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 15px;
        margin-bottom: 15px;
        align-items: end;
      }

      #signupLocationMap {
        height: 300px;
        width: 100%;
        border-radius: 10px;
        border: 2px solid #ced4da;
      }

      .map-instructions {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: 2px solid #2196f3;
        border-radius: 10px;
        padding: 12px;
        margin-top: 10px;
        text-align: center;
      }

      .map-instructions p {
        margin: 0;
        color: #1976d2;
        font-size: 0.9rem;
        font-weight: 600;
      }

      /* Tables */
      .table-container {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        border: 2px solid #e9ecef;
        margin: 15px 0;
      }

      .products-table {
        width: 100%;
        border-collapse: collapse;
      }

      .products-table th,
      .products-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
        vertical-align: middle;
      }

      .products-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2d5016;
        font-size: 0.9rem;
      }

      .products-table input,
      .products-table select {
        margin: 0;
        border: 1px solid #ced4da;
        padding: 8px 12px;
        font-size: 0.9rem;
        border-radius: 6px;
      }

      .products-table input[type="number"] {
        width: 100px;
      }

      .products-table select {
        width: 100%;
        min-width: 120px;
      }

      /* Radio Groups */
      .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 10px;
        flex-wrap: wrap;
      }

      .radio-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: normal;
        cursor: pointer;
        font-size: 1rem;
      }

      .radio-label input[type="radio"] {
        width: auto;
        margin: 0;
        transform: scale(1.1);
      }

      /* Buttons */
      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #3f6b20 0%, #2d5016 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(63, 107, 32, 0.3);
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(63, 107, 32, 0.4);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
        transform: translateY(-2px);
      }

      .btn-danger {
        background: #dc3545;
        color: white;
        padding: 6px 12px;
        font-size: 0.85rem;
      }

      .btn-danger:hover {
        background: #c82333;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .submit-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 15px 40px;
        font-size: 1.1rem;
        font-weight: 600;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        margin-top: 20px;
        width: 100%;
      }

      .submit-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
      }

      /* Messages */
      .message {
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-weight: 600;
        display: none;
      }

      .error-message {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
        border: 2px solid #f5c6cb;
      }

      .success-message {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
        border: 2px solid #c3e6cb;
      }

      /* Forgot ID Section */
      .forgot-section {
        background: rgba(23, 162, 184, 0.1);
        border: 2px solid #17a2b8;
        border-radius: 15px;
        padding: 20px;
        margin-top: 30px;
      }

      .forgot-section h4 {
        color: #17a2b8;
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .forgot-section p {
        color: #666;
        margin-bottom: 15px;
        font-size: 0.95rem;
      }

      .forgot-input-row {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 15px;
        align-items: end;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        body {
          padding: 10px;
          padding-bottom: 50px;
        }

        .header {
          padding: 20px;
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .main-content {
          padding: 20px;
        }

        .form-row {
          grid-template-columns: 1fr;
        }

        .location-input-row {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .radio-group {
          flex-direction: column;
          gap: 15px;
        }

        .products-table,
        .products-table thead,
        .products-table tbody,
        .products-table th,
        .products-table td,
        .products-table tr {
          display: block;
        }

        .products-table thead tr {
          position: absolute;
          top: -9999px;
          left: -9999px;
        }

        .products-table tr {
          border: 2px solid #ddd;
          margin-bottom: 15px;
          padding: 15px;
          border-radius: 10px;
          background: white;
        }

        .products-table td {
          border: none;
          position: relative;
          padding: 8px 0 8px 35%;
          border-bottom: 1px solid #eee;
        }

        .products-table td:before {
          content: attr(data-label);
          position: absolute;
          left: 6px;
          width: 30%;
          padding-right: 10px;
          white-space: nowrap;
          font-weight: 600;
          color: #2d5016;
          font-size: 0.85rem;
        }

        .forgot-input-row {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        #signupLocationMap {
          height: 250px;
        }
      }

      @media (max-width: 480px) {
        .header-title {
          font-size: 1.5rem;
        }

        .form-title {
          font-size: 1.5rem;
        }

        .mode-switcher {
          max-width: 100%;
        }

        .phone-input-container {
          flex-direction: column;
        }

        .country-code-select {
          border-right: none;
          border-bottom: 2px solid #e9ecef;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div class="header-left">
          <img
            src="assets/img/keboon-logo-white.png"
            alt="Keboon"
            class="logo"
            id="headerLogo"
          />
         
        </div>
        <a href="directory.html" class="back-btn">
          <svg viewBox="0 0 24 24">
            <path
              d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"
            />
          </svg>
          Back to Directory
        </a>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Mode Switcher -->
        <div class="mode-switcher">
          <button
            class="mode-btn active"
            id="loginModeBtn"
            onclick="switchMode('login')"
          >
            Login
          </button>
          <button
            class="mode-btn"
            id="signupModeBtn"
            onclick="switchMode('signup')"
          >
            Sign Up
          </button>
        </div>

        <!-- Forms Container -->
        <div class="forms-container">
          <!-- Login Form -->
          <div class="form-section active" id="loginForm">
            <div class="form-header">
              <h2 class="form-title">Farmer Login</h2>
              <p class="form-subtitle">
                Access your farm dashboard and manage your information
              </p>
            </div>

            <div class="form-content">
              <div class="error-message" id="loginError"></div>
              <div class="success-message" id="loginSuccess"></div>

              <form id="loginFormElement">
                <div class="form-group">
                  <label for="loginKeboonId" class="required">Keboon ID</label>
                  <input
                    type="text"
                    id="loginKeboonId"
                    placeholder="KB123ABC..."
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="loginPhone" class="required">Phone Number</label>
                  <div class="phone-input-container">
                    <select
                      id="loginCountryCode"
                      class="country-code-select"
                      required
                    >
                      <option value="+60">🇲🇾 +60</option>
                      <option value="+65">🇸🇬 +65</option>
                      <option value="+62">🇮🇩 +62</option>
                      <option value="+66">🇹🇭 +66</option>
                      <option value="+84">🇻🇳 +84</option>
                      <option value="+63">🇵🇭 +63</option>
                      <option value="+673">🇧🇳 +673</option>
                      <option value="+856">🇱🇦 +856</option>
                      <option value="+855">🇰🇭 +855</option>
                      <option value="+95">🇲🇲 +95</option>
                      <option value="+1">🇺🇸 +1</option>
                      <option value="+44">🇬🇧 +44</option>
                      <option value="+61">🇦🇺 +61</option>
                      <option value="+86">🇨🇳 +86</option>
                      <option value="+81">🇯🇵 +81</option>
                      <option value="+82">🇰🇷 +82</option>
                      <option value="+91">🇮🇳 +91</option>
                    </select>
                    <input
                      type="tel"
                      id="loginPhone"
                      placeholder="123456789"
                      pattern="[0-9]+"
                      required
                    />
                  </div>
                </div>

                <button type="submit" class="submit-btn" id="loginSubmitBtn">
                  Login to Dashboard
                </button>
              </form>

              <!-- Forgot ID Section -->
              <div class="forgot-section">
                <h4>Forgot Your Keboon ID?</h4>
                <p>
                  Enter your registered email address and we'll send your Keboon
                  ID to you.
                </p>
                <div class="forgot-input-row">
                  <input
                    type="email"
                    id="forgotEmail"
                    placeholder="your.email@example.com"
                  />
                  <button
                    type="button"
                    class="btn btn-secondary"
                    onclick="sendKeboonId()"
                  >
                    Send ID
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Signup Form -->
          <div class="form-section" id="signupForm">
            <div class="form-header">
              <h2 class="form-title">Add Your Farm</h2>
              <p class="form-subtitle">
                Join the Keboon Directory and connect with your local community
              </p>
            </div>

            <div class="form-content">
              <div class="error-message" id="signupError"></div>
              <div class="success-message" id="signupSuccess"></div>

              <form id="signupFormElement">
                <div class="form-group">
                  <label for="farmName" class="required"
                    >Farm/Business Name</label
                  >
                  <input type="text" id="farmName" name="farmName" required />
                </div>

                <div class="form-group">
                  <label for="contactName" class="required"
                    >Contact Person Name</label
                  >
                  <input
                    type="text"
                    id="contactName"
                    name="contactName"
                    required
                  />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="category" class="required">Farm Category</label>
                    <select id="category" name="category" required>
                      <option value="">Select Category</option>
                      <option value="Home Grower">
                        Home Grower (micro/backyard)
                      </option>
                      <option value="Homesteading">
                        Homesteading (medium-small)
                      </option>
                      <option value="Small Scale">
                        Small Scale (&lt;1.5 ha)
                      </option>
                      <option value="Medium Scale">Medium Scale</option>
                      <option value="Large Scale">Large Scale</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label for="commercial" class="required"
                      >Commercial Status</label
                    >
                    <select id="commercial" name="commercial" required>
                      <option value="">Select Status</option>
                      <option value="Commercial">Commercial</option>
                      <option value="Non-commercial">Non-commercial</option>
                    </select>
                  </div>
                </div>

                <div class="form-group">
                  <label for="farmLocation" class="required"
                    >Farm Location</label
                  >
                  <div class="location-section">
                    <div class="location-input-row">
                      <input
                        type="number"
                        id="latitude"
                        name="latitude"
                        step="any"
                        required
                        placeholder="Latitude (e.g., 3.139)"
                        oninput="autoUpdateMapFromCoordinates()"
                      />
                      <input
                        type="number"
                        id="longitude"
                        name="longitude"
                        step="any"
                        required
                        placeholder="Longitude (e.g., 101.6869)"
                        oninput="autoUpdateMapFromCoordinates()"
                      />
                      <button
                        type="button"
                        class="btn btn-primary"
                        onclick="getCurrentLocation()"
                      >
                        Use My Location
                      </button>
                    </div>
                    <div id="signupLocationMap"></div>
                    <div class="map-instructions">
                      <p>
                        Click on the map to set your farm location, or use the
                        "Use My Location" button
                      </p>
                    </div>
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="phone" class="required">Phone Number</label>
                    <div class="phone-input-container">
                      <select
                        id="countryCode"
                        name="countryCode"
                        class="country-code-select"
                        required
                      >
                        <option value="+60">🇲🇾 +60</option>
                        <option value="+65">🇸🇬 +65</option>
                        <option value="+62">🇮🇩 +62</option>
                        <option value="+66">🇹🇭 +66</option>
                        <option value="+84">🇻🇳 +84</option>
                        <option value="+63">🇵🇭 +63</option>
                        <option value="+673">🇧🇳 +673</option>
                        <option value="+856">🇱🇦 +856</option>
                        <option value="+855">🇰🇭 +855</option>
                        <option value="+95">🇲🇲 +95</option>
                        <option value="+1">🇺🇸 +1</option>
                        <option value="+44">🇬🇧 +44</option>
                        <option value="+61">🇦🇺 +61</option>
                        <option value="+86">🇨🇳 +86</option>
                        <option value="+81">🇯🇵 +81</option>
                        <option value="+82">🇰🇷 +82</option>
                        <option value="+91">🇮🇳 +91</option>
                      </select>
                      <input
                        type="tel"
                        id="phone"
                        name="phone"
                        placeholder="123456789"
                        pattern="[0-9]+"
                        required
                      />
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="email" class="required">Email Address</label>
                    <input type="email" id="email" name="email" required />
                  </div>
                </div>

                <div class="form-group">
                  <label for="address" class="required"
                    >Address/Location Description</label
                  >
                  <textarea
                    id="address"
                    name="address"
                    placeholder="e.g., 123 Farm Road, Village Name, District"
                    required
                  ></textarea>
                </div>

                <div class="form-group">
                  <label for="products" class="required">Product List</label>
                  <div class="table-container">
                    <table class="products-table" id="productsTable">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Availability</th>
                          <th>Price (RM)</th>
                          <th>Unit</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody id="productsTableBody">
                        <tr>
                          <td data-label="Name">
                            <input
                              type="text"
                              name="productName[]"
                              placeholder="e.g., Tomatoes"
                              required
                            />
                          </td>
                          <td data-label="Availability">
                            <input
                              type="text"
                              name="productSeason[]"
                              placeholder="e.g., March-Oct"
                              required
                            />
                          </td>
                          <td data-label="Price (RM)">
                            <input
                              type="number"
                              name="productPrice[]"
                              step="0.01"
                              min="0"
                              placeholder="0.00"
                              required
                            />
                          </td>
                          <td data-label="Unit">
                            <select name="productUnit[]" required>
                              <option value="">Select Unit</option>
                              <option value="kg">per kg</option>
                              <option value="g">per g</option>
                              <option value="l">per liter</option>
                              <option value="ml">per ml</option>
                              <option value="piece">per piece</option>
                              <option value="dozen">per dozen</option>
                              <option value="bundle">per bundle</option>
                              <option value="box">per box</option>
                              <option value="bag">per bag</option>
                              <option value="tray">per tray</option>
                              <option value="pack">per pack</option>
                              <option value="bunch">per bunch</option>
                            </select>
                          </td>
                          <td data-label="Action">
                            <button
                              type="button"
                              class="btn btn-danger"
                              onclick="removeProductRow(this)"
                              disabled
                            >
                              Remove
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <button
                    type="button"
                    class="btn btn-success"
                    onclick="addProductRow()"
                  >
                    + Add Another Product
                  </button>
                </div>

                <div class="form-group">
                  <label for="farmSize" class="required">Farm Size</label>
                  <input
                    type="text"
                    id="farmSize"
                    name="farmSize"
                    placeholder="e.g., 0.5 hectares"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="websites" class="required"
                    >Website/Social Media Links</label
                  >
                  <div class="table-container">
                    <table class="products-table" id="websitesTable">
                      <thead>
                        <tr>
                          <th>URL/Link</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody id="websitesTableBody">
                        <tr>
                          <td data-label="URL">
                            <input
                              type="url"
                              name="websiteUrl[]"
                              placeholder="https://..."
                              required
                            />
                          </td>
                          <td data-label="Action">
                            <button
                              type="button"
                              class="btn btn-danger"
                              onclick="removeWebsiteRow(this)"
                              disabled
                            >
                              Remove
                            </button>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <button
                    type="button"
                    class="btn btn-success"
                    onclick="addWebsiteRow()"
                  >
                    + Add Another Link
                  </button>
                </div>

                <div class="form-group">
                  <label for="description" class="required"
                    >Brief Description</label
                  >
                  <textarea
                    id="description"
                    name="description"
                    placeholder="Tell us about your farm, farming methods, what makes you unique..."
                    required
                  ></textarea>
                </div>

                <div class="form-group">
                  <label class="required">Available for visits/tours?</label>
                  <div class="radio-group">
                    <label class="radio-label">
                      <input
                        type="radio"
                        name="visitsAllowed"
                        value="Yes"
                        required
                      />
                      Yes, visitors welcome
                    </label>
                    <label class="radio-label">
                      <input
                        type="radio"
                        name="visitsAllowed"
                        value="No"
                        required
                      />
                      No, not open for visits
                    </label>
                  </div>
                </div>

                <button type="submit" class="submit-btn" id="signupSubmitBtn">
                  Add My Farm to Keboon Directory
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <script>
      // Global variables
      let signupLocationMap;
      let locationMarker = null;
      let currentMode = "login";

      // Google Apps Script URL
      const APPS_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbxXSsGq5vCpJttfjbkC8rg6j4pYDO4Zbylx4jsByb9QYwH0gMdo5miFahxZWStM20P6/exec";

      // Initialize page based on URL parameters
      function initializePage() {
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get("mode");

        if (mode === "signup") {
          switchMode("signup");
        } else {
          switchMode("login");
        }
      }

      // Switch between login and signup modes
      function switchMode(mode) {
        currentMode = mode;

        // Update buttons
        document
          .getElementById("loginModeBtn")
          .classList.toggle("active", mode === "login");
        document
          .getElementById("signupModeBtn")
          .classList.toggle("active", mode === "signup");

        // Update forms
        document
          .getElementById("loginForm")
          .classList.toggle("active", mode === "login");
        document
          .getElementById("signupForm")
          .classList.toggle("active", mode === "signup");

        // Initialize signup map if needed
        if (mode === "signup" && !signupLocationMap) {
          setTimeout(() => {
            initializeLocationMap();
          }, 300);
        }

        // Clear any existing messages
        hideMessages("login");
        hideMessages("signup");
      }

      // Initialize location map for signup
      function initializeLocationMap() {
        const defaultCenter = [3.139, 101.6869]; // Kuala Lumpur

        signupLocationMap = L.map("signupLocationMap").setView(
          defaultCenter,
          12
        );

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: "© OpenStreetMap contributors",
          maxZoom: 18,
        }).addTo(signupLocationMap);

        // Try to center on user's location
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              const userLocation = [
                position.coords.latitude,
                position.coords.longitude,
              ];
              signupLocationMap.setView(userLocation, 15);
            },
            function (error) {
              console.log("Geolocation error:", error);
            }
          );
        }

        // Add click event to set farm location
        signupLocationMap.on("click", function (e) {
          setFarmLocation(e.latlng.lat, e.latlng.lng);
        });
      }

      // Set farm location on map
      function setFarmLocation(lat, lng) {
        // Update form fields
        document.getElementById("latitude").value = lat.toFixed(6);
        document.getElementById("longitude").value = lng.toFixed(6);

        // Remove existing marker if any
        if (locationMarker) {
          signupLocationMap.removeLayer(locationMarker);
        }

        // Add new marker
        locationMarker = L.marker([lat, lng], {
          icon: L.icon({
            iconUrl:
              "data:image/svg+xml;charset=UTF-8," +
              encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#3f6b20" width="30" height="30">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                    `),
            iconSize: [30, 30],
            iconAnchor: [15, 30],
          }),
          draggable: true,
        }).addTo(signupLocationMap);

        locationMarker.bindPopup(
          `<b>Your Farm Location</b><br>Lat: ${lat.toFixed(
            6
          )}<br>Lng: ${lng.toFixed(6)}`
        );

        // Make marker draggable
        locationMarker.on("dragend", function (e) {
          const newPos = e.target.getLatLng();
          setFarmLocation(newPos.lat, newPos.lng);
        });
      }

      // Get current location
      function getCurrentLocation() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;

              signupLocationMap.setView([lat, lng], 16);
              setFarmLocation(lat, lng);
            },
            function (error) {
              showError(
                "Unable to get your location. Please click on the map to set your farm location manually.",
                "signup"
              );
            }
          );
        } else {
          showError(
            "Geolocation is not supported by this browser. Please click on the map to set your location.",
            "signup"
          );
        }
      }

      // Auto-update map when coordinates are entered
      let coordinateUpdateTimeout;
      function autoUpdateMapFromCoordinates() {
        if (coordinateUpdateTimeout) {
          clearTimeout(coordinateUpdateTimeout);
        }

        coordinateUpdateTimeout = setTimeout(() => {
          const latInput = document.getElementById("latitude");
          const lngInput = document.getElementById("longitude");

          const lat = parseFloat(latInput.value);
          const lng = parseFloat(lngInput.value);

          if (
            !isNaN(lat) &&
            !isNaN(lng) &&
            lat >= -90 &&
            lat <= 90 &&
            lng >= -180 &&
            lng <= 180 &&
            latInput.value &&
            lngInput.value
          ) {
            if (signupLocationMap) {
              signupLocationMap.setView([lat, lng], 16);
              setFarmLocation(lat, lng);
            }
          }
        }, 500);
      }

      // Product table management
      function addProductRow() {
        const tbody = document.getElementById("productsTableBody");
        const rowCount = tbody.rows.length;

        if (rowCount >= 10) {
          showError("Maximum 10 products allowed.", "signup");
          return;
        }

        const newRow = tbody.insertRow();
        newRow.innerHTML = `
                <td data-label="Name"><input type="text" name="productName[]" placeholder="e.g., Tomatoes" required></td>
                <td data-label="Availability"><input type="text" name="productSeason[]" placeholder="e.g., March-Oct" required></td>
                <td data-label="Price (RM)"><input type="number" name="productPrice[]" step="0.01" min="0" placeholder="0.00" required></td>
                <td data-label="Unit">
                    <select name="productUnit[]" required>
                        <option value="">Select Unit</option>
                        <option value="kg">per kg</option>
                        <option value="g">per g</option>
                        <option value="l">per liter</option>
                        <option value="ml">per ml</option>
                        <option value="piece">per piece</option>
                        <option value="dozen">per dozen</option>
                        <option value="bundle">per bundle</option>
                        <option value="box">per box</option>
                        <option value="bag">per bag</option>
                        <option value="tray">per tray</option>
                        <option value="pack">per pack</option>
                        <option value="bunch">per bunch</option>
                    </select>
                </td>
                <td data-label="Action"><button type="button" class="btn btn-danger" onclick="removeProductRow(this)">Remove</button></td>
            `;

        updateRemoveButtons("products");
      }

      function removeProductRow(button) {
        const tbody = document.getElementById("productsTableBody");
        if (tbody.rows.length > 1) {
          button.closest("tr").remove();
          updateRemoveButtons("products");
        }
      }

      // Website table management
      function addWebsiteRow() {
        const tbody = document.getElementById("websitesTableBody");
        const rowCount = tbody.rows.length;

        if (rowCount >= 10) {
          showError("Maximum 10 links allowed.", "signup");
          return;
        }

        const newRow = tbody.insertRow();
        newRow.innerHTML = `
                <td data-label="URL"><input type="url" name="websiteUrl[]" placeholder="https://..." required></td>
                <td data-label="Action"><button type="button" class="btn btn-danger" onclick="removeWebsiteRow(this)">Remove</button></td>
            `;

        updateRemoveButtons("websites");
      }

      function removeWebsiteRow(button) {
        const tbody = document.getElementById("websitesTableBody");
        if (tbody.rows.length > 1) {
          button.closest("tr").remove();
          updateRemoveButtons("websites");
        }
      }

      // Update remove button states
      function updateRemoveButtons(tableType) {
        const tbody = document.getElementById(tableType + "TableBody");
        const removeButtons = tbody.querySelectorAll(".btn-danger");

        removeButtons.forEach((button, index) => {
          button.disabled = tbody.rows.length === 1;
        });
      }

      // Get full phone number with country code
      function getFullPhoneNumber(prefix = "") {
        const countryCode = document.getElementById(
          prefix + "countryCode"
        ).value;
        const phoneNumber = document.getElementById(prefix + "phone").value;

        const cleanNumber = phoneNumber.replace(/\D/g, "");
        const cleanCountryCode = countryCode.replace("+", "");

        return cleanCountryCode + cleanNumber;
      }

      // Get login phone number
      function getLoginPhoneNumber() {
        const countryCode = document.getElementById("loginCountryCode").value;
        const phoneNumber = document.getElementById("loginPhone").value;

        const cleanNumber = phoneNumber.replace(/\D/g, "");
        const cleanCountryCode = countryCode.replace("+", "");

        return cleanCountryCode + cleanNumber;
      }

      // Collect products data as JSON
      function collectProductsData() {
        const products = [];
        const nameInputs = document.querySelectorAll(
          'input[name="productName[]"]'
        );
        const seasonInputs = document.querySelectorAll(
          'input[name="productSeason[]"]'
        );
        const priceInputs = document.querySelectorAll(
          'input[name="productPrice[]"]'
        );
        const unitSelects = document.querySelectorAll(
          'select[name="productUnit[]"]'
        );

        for (let i = 0; i < nameInputs.length; i++) {
          const name = nameInputs[i].value.trim();
          const season = seasonInputs[i].value.trim();
          const price = parseFloat(priceInputs[i].value) || 0;
          const unit = unitSelects[i].value;

          if (name) {
            products.push({
              name: name,
              season: season || "Not specified",
              price: price,
              unit: unit || "piece",
            });
          }
        }

        return JSON.stringify(products);
      }

      // Collect websites data as JSON
      function collectWebsitesData() {
        const websites = [];
        const urlInputs = document.querySelectorAll(
          'input[name="websiteUrl[]"]'
        );

        for (let i = 0; i < urlInputs.length; i++) {
          const url = urlInputs[i].value.trim();
          if (url) {
            websites.push(url);
          }
        }

        return JSON.stringify(websites);
      }

      // Form validation for signup
      function validateSignupForm() {
        hideMessages("signup");

        // Check if location is set
        const lat = document.getElementById("latitude").value;
        const lng = document.getElementById("longitude").value;

        if (!lat || !lng) {
          showError(
            'Please set your farm location by clicking on the map or using the "Use My Location" button.',
            "signup"
          );
          return false;
        }

        // Check if at least one product is filled
        const nameInputs = document.querySelectorAll(
          'input[name="productName[]"]'
        );
        let hasProduct = false;

        for (let input of nameInputs) {
          if (input.value.trim()) {
            hasProduct = true;
            break;
          }
        }

        if (!hasProduct) {
          showError("Please add at least one product/crop.", "signup");
          return false;
        }

        // Check if at least one website is filled
        const urlInputs = document.querySelectorAll(
          'input[name="websiteUrl[]"]'
        );
        let hasWebsite = false;

        for (let input of urlInputs) {
          if (input.value.trim()) {
            hasWebsite = true;
            break;
          }
        }

        if (!hasWebsite) {
          showError(
            "Please add at least one website or social media link.",
            "signup"
          );
          return false;
        }

        return true;
      }

      // Handle login form submission
      async function handleLogin(event) {
        event.preventDefault();

        const keboonId = document.getElementById("loginKeboonId").value.trim();
        const phone = getLoginPhoneNumber();

        if (!keboonId || !phone) {
          showError("Please enter both Keboon ID and phone number", "login");
          return;
        }

        const submitBtn = document.getElementById("loginSubmitBtn");
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = "Logging in...";

        try {
          const response = await fetch(
            `${APPS_SCRIPT_URL}?action=getFarmerById&keboonId=${encodeURIComponent(
              keboonId
            )}&phone=${encodeURIComponent(phone)}`
          );
          const result = await response.json();

          if (result.success && result.farmer) {
            showSuccess(
              "Login successful! Redirecting to dashboard...",
              "login"
            );

            // Redirect to farmer dashboard with farmer data
            setTimeout(() => {
              window.location.href = `farmer-dashboard.html?keboonId=${encodeURIComponent(
                keboonId
              )}&phone=${encodeURIComponent(phone)}`;
            }, 1500);
          } else {
            throw new Error(
              result.error ||
                "Invalid credentials. Please check your Keboon ID and phone number."
            );
          }
        } catch (error) {
          console.error("Login error:", error);
          showError(`Login failed: ${error.message}`, "login");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }

      // Handle signup form submission
      async function handleSignup(event) {
        event.preventDefault();

        if (!validateSignupForm()) {
          return;
        }

        const submitBtn = document.getElementById("signupSubmitBtn");
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = "Adding Your Farm...";

        try {
          const formData = new FormData(
            document.getElementById("signupFormElement")
          );
          const productsJson = collectProductsData();
          const websitesJson = collectWebsitesData();

          const submission = {
            farmName: formData.get("farmName"),
            contactName: formData.get("contactName"),
            category: formData.get("category"),
            commercial: formData.get("commercial"),
            latitude: parseFloat(formData.get("latitude")),
            longitude: parseFloat(formData.get("longitude")),
            phone: getFullPhoneNumber(),
            email: formData.get("email"),
            address: formData.get("address"),
            products: productsJson,
            farmSize: formData.get("farmSize"),
            websites: websitesJson,
            description: formData.get("description"),
            visitsAllowed: formData.get("visitsAllowed"),
            timestamp: new Date().toISOString(),
          };

          const params = new URLSearchParams({
            action: "addFarmer",
            data: JSON.stringify(submission),
          });

          const response = await fetch(
            `${APPS_SCRIPT_URL}?${params.toString()}`
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();

          if (result.success) {
            if (result.keboonId) {
              showSuccess(
                `Farm added successfully! Your Keboon ID is: <strong>${result.keboonId}</strong><br><br>Please save this ID for future logins. Redirecting to dashboard...`,
                "signup"
              );

              // Redirect to farmer dashboard
              setTimeout(() => {
                window.location.href = `farmer-dashboard.html?keboonId=${encodeURIComponent(
                  result.keboonId
                )}&phone=${encodeURIComponent(submission.phone)}`;
              }, 3000);
            } else {
              showSuccess(
                "Farm added successfully to Keboon Directory!",
                "signup"
              );
            }
          } else {
            throw new Error(result.error || "Failed to add farm");
          }
        } catch (error) {
          console.error("Signup error:", error);
          showError(`Error: ${error.message}`, "signup");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      }

      // Send Keboon ID to email
      async function sendKeboonId() {
        const email = document.getElementById("forgotEmail").value.trim();

        if (!email) {
          showError("Please enter your email address", "login");
          return;
        }

        const sendBtn = event.target;
        const originalText = sendBtn.textContent;
        sendBtn.disabled = true;
        sendBtn.textContent = "Sending...";

        try {
          const response = await fetch(
            `${APPS_SCRIPT_URL}?action=sendKeboonId&email=${encodeURIComponent(
              email
            )}`
          );

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const result = await response.json();

          if (result.success) {
            showSuccess(
              `Keboon ID sent to ${email}! Please check your email (including spam folder).`,
              "login"
            );
            document.getElementById("forgotEmail").value = "";
          } else {
            throw new Error(result.error || "Failed to send Keboon ID");
          }
        } catch (error) {
          console.error("Error sending Keboon ID:", error);
          showError(`Error: ${error.message}`, "login");
        } finally {
          sendBtn.disabled = false;
          sendBtn.textContent = originalText;
        }
      }

      // Show/hide messages
      function showError(message, formType) {
        const errorDiv = document.getElementById(formType + "Error");
        errorDiv.innerHTML = message;
        errorDiv.style.display = "block";
        document.getElementById(formType + "Success").style.display = "none";
      }

      function showSuccess(message, formType) {
        const successDiv = document.getElementById(formType + "Success");
        successDiv.innerHTML = message;
        successDiv.style.display = "block";
        document.getElementById(formType + "Error").style.display = "none";
      }

      function hideMessages(formType) {
        document.getElementById(formType + "Error").style.display = "none";
        document.getElementById(formType + "Success").style.display = "none";
      }

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        // Handle logo error
        const logo = document.getElementById("headerLogo");
        logo.addEventListener("error", function () {
          this.style.display = "none";
        });

        // Initialize page mode
        initializePage();

        // Add form event listeners
        document
          .getElementById("loginFormElement")
          .addEventListener("submit", handleLogin);
        document
          .getElementById("signupFormElement")
          .addEventListener("submit", handleSignup);

        // Initialize remove button states
        updateRemoveButtons("products");
        updateRemoveButtons("websites");

        // Add phone input validation
        const phoneInputs = document.querySelectorAll('input[type="tel"]');
        phoneInputs.forEach((input) => {
          input.addEventListener("input", function (e) {
            this.value = this.value.replace(/\D/g, "");
          });
        });
      });
    </script>
  </body>
</html>
